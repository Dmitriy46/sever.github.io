<script>
  // –ë–∞–∑–æ–≤—ã–π URL –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Render
  const API_BASE_URL = 'https://sever-github-io.onrender.com';
  let currentSheet = '';
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
  document.addEventListener('DOMContentLoaded', loadSheets);
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ª–∏—Å—Ç–æ–≤
  async function loadSheets() {
    showStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ª–∏—Å—Ç–æ–≤...");
    try {
      const response = await fetch(`${API_BASE_URL}/sheets`);
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞');
      
      const sheets = await response.json();
      const selector = document.getElementById('sheetSelector');
      selector.innerHTML = sheets.map(sheet => 
        `<option value="${sheet}">${sheet}</option>`
      ).join('');
      
      if (sheets.length > 0) {
        currentSheet = sheets[0];
        selector.value = currentSheet;
        await loadSheet();
      }
    } catch (error) {
      showError(error);
    }
  }
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç–∞
  async function loadSheet() {
    const sheetName = document.getElementById('sheetSelector').value;
    if (!sheetName) return;
    
    showStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ "${sheetName}"...`);
    try {
      const response = await fetch(`${API_BASE_URL}/sheets/${encodeURIComponent(sheetName)}`);
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
      
      const data = await response.json();
      updateTable(data);
      showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω –ª–∏—Å—Ç "${sheetName}"`, 'success');
    } catch (error) {
      showError(error);
    }
  }
  
  // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function updateTable(data) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    
    data.forEach(row => {
      const tr = document.createElement('tr');
      for (let i = 0; i < 6; i++) {
        const td = document.createElement('td');
        td.contentEditable = true;
        td.textContent = row[i] || '';
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    });
  }
  
  // –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function addRow() {
    const tbody = document.querySelector('#dataTable tbody');
    const tr = document.createElement('tr');
    
    for (let i = 0; i < 6; i++) {
      const td = document.createElement('td');
      td.contentEditable = true;
      tr.appendChild(td);
    }
    
    tbody.appendChild(tr);
    tr.scrollIntoView({ behavior: 'smooth' });
    tr.firstChild.focus();
  }
  
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
  async function saveData() {
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    const data = rows.map(row => 
      Array.from(row.cells).map(cell => cell.textContent)
    );
    
    if (!currentSheet) {
      showError("–ù–µ –≤—ã–±—Ä–∞–Ω –ª–∏—Å—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
      return;
    }
    
    showStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...");
    try {
      const response = await fetch(`${API_BASE_URL}/sheets/${encodeURIComponent(currentSheet)}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      
      showStatus(`–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ "${currentSheet}"`, 'success');
    } catch (error) {
      showError(error);
    }
  }
  
  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
  async function sendData() {
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    const message = formatMessage(rows);
    
    showStatus("–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...");
    try {
      const response = await fetch(`${API_BASE_URL}/send-to-telegram`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message })
      });
      
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
      
      showStatus("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram", 'success');
    } catch (error) {
      showError(error);
    }
  }
  
  // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function copyData() {
    const rows = Array.from(document.querySelectorAll('#dataTable tbody tr'));
    const message = formatMessage(rows);
    
    navigator.clipboard.writeText(message)
      .then(() => showStatus("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!", 'success'))
      .catch(err => showError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å: " + err));
  }
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function formatMessage(rows) {
    return rows
      .map((row, i) => {
        const cells = Array.from(row.cells).map(c => c.textContent.trim());
        return cells[0] ? 
          `${i+1}. üöõ ${cells[0]}\nüì¶ ${cells[1]}\nüìç ${cells[2]} ‚Üí ${cells[3]}\nüë§ ${cells[4]}\nüìù ${cells[5] || '-'}\n` : 
          null;
      })
      .filter(Boolean)
      .join('\n');
  }
  
  // –°–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç
  async function createNewSheet() {
    const sheetName = document.getElementById('newSheetName').value.trim();
    if (!sheetName) {
      showError("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞");
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE_URL}/sheets`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name: sheetName })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∞');
      }
      
      hideDialog('addDialog');
      await loadSheets();
      showStatus(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ª–∏—Å—Ç "${sheetName}"`, 'success');
    } catch (error) {
      showError(error);
    }
  }
  
  // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–∏—Å—Ç
  async function renameSheet() {
    const newName = document.getElementById('renameSheetName').value.trim();
    if (!newName) {
      showError("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE_URL}/sheets/${encodeURIComponent(currentSheet)}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ newName })
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è');
      }
      
      currentSheet = newName;
      hideDialog('renameDialog');
      await loadSheets();
      showStatus(`–õ–∏—Å—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ "${newName}"`, 'success');
    } catch (error) {
      showError(error);
    }
  }
  
  // –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ
  async function confirmDelete() {
    const confirmText = document.getElementById('confirmDeleteText').value.trim();
    if (confirmText !== "–£–î–ê–õ–ò–¢–¨") {
      showError("–í–≤–µ–¥–∏—Ç–µ –£–î–ê–õ–ò–¢–¨ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
      return;
    }
    
    try {
      const response = await fetch(`${API_BASE_URL}/sheets/${encodeURIComponent(currentSheet)}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
      }
      
      hideDialog('deleteDialog');
      await loadSheets();
      showStatus(`–õ–∏—Å—Ç "${currentSheet}" —É–¥–∞–ª–µ–Ω`, 'success');
      currentSheet = (await response.json())[0] || '';
    } catch (error) {
      showError(error);
    }
  }
  
  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  function showDialog(id) {
    document.getElementById(id).style.display = 'flex';
  }
  
  function hideDialog(id) {
    document.getElementById(id).style.display = 'none';
  }
  
  function showStatus(message, type = '') {
    const statusEl = document.getElementById('status');
    statusEl.textContent = message;
    statusEl.className = 'status ' + type;
  }
  
  function showError(error) {
    console.error(error);
    showStatus(typeof error === 'string' ? error : error.message, 'error');
  }
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function showRenameDialog() {
    if (!currentSheet) {
      showError("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç");
      return;
    }
    
    document.getElementById('renameSheetName').value = currentSheet;
    showDialog('renameDialog');
    document.getElementById('renameSheetName').focus();
  }
  
  // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ —É–¥–∞–ª–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  function showDeleteDialog() {
    if (!currentSheet) {
      showError("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏—Å—Ç");
      return;
    }
    
    document.getElementById('deleteSheetName').textContent = currentSheet;
    document.getElementById('confirmDeleteText').value = '';
    showDialog('deleteDialog');
    document.getElementById('confirmDeleteText').focus();
  }
</script>