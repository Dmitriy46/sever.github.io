<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–î–∏—Å–ø–µ—Ç—á–µ—Ä –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫</title>
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-size: 18px;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .date-selector {
      margin-top: 10px;
    }
    
    .date-selector select {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.9);
      color: #333;
    }

    /* –û–±–ª–∞—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å */
    .cloud-status {
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .cloud-status.online {
      background: rgba(72, 187, 120, 0.3);
      color: #2d7d32;
    }

    .cloud-status.syncing {
      background: rgba(255, 193, 7, 0.3);
      color: #f57f17;
      animation: pulse 1.5s infinite;
    }

    .cloud-status.offline {
      background: rgba(244, 67, 54, 0.3);
      color: #c62828;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* –ì–ª–∞–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .main-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .big-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
      border: none;
      border-radius: 12px;
      background: #f8f9fa;
      color: #333;
      font-size: 14px;
      min-height: 80px;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
    }
    
    .big-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .big-button:active {
      transform: scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .big-button .icon {
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .big-button.primary {
      background: #667eea;
      color: white;
    }
    
    .big-button.success {
      background: #48bb78;
      color: white;
    }
    
    .big-button.danger {
      background: #f56565;
      color: white;
    }
    
    .big-button.warning {
      background: #f39c12;
      color: white;
    }
    
    /* –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞–Ω–∏–π */
    .tasks-container {
      padding: 15px;
      min-height: 200px;
    }
    
    .task-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      transition: all 0.2s;
    }
    
    .task-card.selected {
      background: #e6f4ff;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
    }

    .task-card.editing {
      background: #f8fff8;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.15);
      border-left: 4px solid #48bb78;
    }
    
    .task-card .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .task-card .machine-name {
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      min-height: 40px;
      background: white;
      transition: all 0.2s;
      outline: none;
    }
    
    .task-card .machine-name:empty:before {
      content: "–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤–≤–æ–¥–∞ –º–∞—à–∏–Ω(—ã)";
      color: #ff6666;
      font-style: italic;
      font-weight: normal;
      font-size: 18px;
    }
    
    .task-card .machine-name:focus {
      border-color: #667eea;
      background: white;
    }
    
    .task-card .select-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .task-detail {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      margin-bottom: 8px;
      align-items: start;
    }
    
    .task-detail .label {
      font-size: 16px;
      color: #666;
      min-width: 110px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .task-detail .value {
      font-size: 16px;
      color: #333;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: all 0.2s;
      outline: none;
    }
    
    .task-detail .value:focus {
      border-color: #667eea;
      background: white;
    }
    
    .task-detail .value:empty:before {
      content: attr(placeholder);
      color: #999;
      font-style: italic;
    }
    
    /* –ü–æ–¥–∑–∞–∫–∞–∑—ã */
    .task-card .sub-orders {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    .sub-order {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      position: relative;
    }
    
    .sub-order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .remove-sub-order {
      width: 24px;
      height: 24px;
      border: none;
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
    }
    
    .add-sub-order-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 2px dashed #667eea;
      background: transparent;
      color: #667eea;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .add-sub-order-btn:active {
      background: #667eea;
      color: white;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
    .more-actions {
      padding: 0 15px 15px 15px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .secondary-button {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      font-size: 16px;
      color: #666;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .secondary-button:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }
    
    .secondary-button:active {
      background: #f0f0f0;
      transform: translateY(0);
    }
    
    /* –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏—è */
    .status {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 25px;
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-size: 16px;
      z-index: 1001;
      display: none;
      max-width: 90%;
      text-align: center;
    }

    .status.show {
      display: block;
      animation: statusFade 3s ease-in-out forwards;
    }

    @keyframes statusFade {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    .status.success {
      background: #48bb78;
      color: white;
    }
    
    .status.error {
      background: #f56565;
      color: white;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: modalSlide 0.3s ease-out;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      font-size: 22px;
      color: #333;
    }
    
    .modal input {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 15px;
      outline: none;
      box-sizing: border-box;
    }
    
    .modal input:focus {
      border-color: #667eea;
    }

    .modal code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-button {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .modal-button:hover {
      transform: translateY(-1px);
    }
    
    .modal-button.cancel {
      background: #f0f0f0;
      color: #666;
    }
    
    .modal-button.confirm {
      background: #667eea;
      color: white;
    }
    
    .modal-button.danger {
      background: #f56565;
      color: white;
    }
    
    /* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
    .hidden-input {
      display: none;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∞–≤–∏—à */
    kbd {
      background: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 0 0 2px #fff inset;
      color: #333;
      display: inline-block;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      margin: 0 2px;
      padding: 2px 6px;
      text-shadow: 0 1px 0 #fff;
    }
    
    /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –ø–æ–ª–µ–π */
    .task-detail .value,
    .task-card .machine-name {
      transition: all 0.2s ease;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ —Ñ–æ–∫—É—Å–∞ */
    @keyframes focusGlow {
      0% {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.3);
        transform: scale(1.05);
      }
      100% {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: scale(1.02);
      }
    }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    @media (min-width: 768px) {
      .main-actions {
        grid-template-columns: repeat(4, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .more-actions {
        grid-template-columns: repeat(4, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .tasks-container {
        max-width: 800px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã –î–∏—Å–ø–µ—Ç—á–µ—Ä –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫</h1>
    <div class="date-selector">
      <select id="sheetSelector" onchange="loadSheet()">
        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
      </select>
    </div>
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div id="cloudStatus" class="cloud-status" style="display: none;">
      <span id="cloudIcon">‚òÅÔ∏è</span>
      <span id="cloudText">–õ–æ–∫–∞–ª—å–Ω–æ</span>
    </div>
  </div>
  
  <div class="main-actions">
    <button onclick="addNewTask()" class="big-button warning">
      <span class="icon">‚ûï</span>
      <span class="text">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</span>
    </button>
    <button onclick="saveData()" class="big-button success">
      <span class="icon">üíæ</span>
      <span class="text">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
    </button>
    <button onclick="sendToTelegram()" class="big-button primary">
      <span class="icon">üì§</span>
      <span class="text">Telegram</span>
    </button>
    <button onclick="copyToClipboard()" class="big-button">
      <span class="icon">üìã</span>
      <span class="text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
    </button>
    <button onclick="showTelegramSettings()" class="big-button">
      <span class="icon">‚öôÔ∏è</span>
      <span class="text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </button>
    <button onclick="showCloudSync()" class="big-button success" id="cloudBtn">
      <span class="icon">‚òÅÔ∏è</span>
      <span class="text">–û–±–ª–∞–∫–æ</span>
    </button>
  </div>
  
  <div class="tasks-container" id="tasksContainer">
    <div class="empty-state">
      <div class="icon">üìã</div>
      <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

  <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
  <div id="navigationTip" style="text-align: center; padding: 10px; background: #f8f9fa; margin: 0 15px; border-radius: 8px; font-size: 14px; color: #666; border-left: 4px solid #667eea; display: none;">
    üí° <strong>–°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <kbd>Enter</kbd> –∏–ª–∏ <kbd>Tab</kbd> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
  </div>
  
  <div class="more-actions">
    <button onclick="duplicateSelected()" class="secondary-button">üìë –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
    <button onclick="deleteSelected()" class="secondary-button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    <button onclick="exportAllData()" class="secondary-button">üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
    <button onclick="importAllData()" class="secondary-button">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
  </div>

  <!-- –°—Ç–∞—Ç—É—Å -->
  <div id="status" class="status"></div>

  <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–æ–≤ -->
  <input type="file" id="dataImportInput" class="hidden-input" accept=".json" onchange="handleDataImport(event)">
  
  <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <h3>üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞</h3>
      <input type="text" id="newSheetName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 12.06.2025">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('createModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button confirm" onclick="createNewSheet()">–°–æ–∑–¥–∞—Ç—å</button>
      </div>
    </div>
  </div>
  
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <h3>‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</h3>
      <input type="text" id="renameInput" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('renameModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button confirm" onclick="confirmRename()">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
      </div>
    </div>
  </div>
  
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ª–∏—Å—Ç?</h3>
      <p id="deleteText" style="margin: 20px 0; text-align: center; color: #666;"></p>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('deleteModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button danger" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>
  
  <div id="manageModal" class="modal">
    <div class="modal-content">
      <h3>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞–º–∏</h3>
      <button class="modal-button" onclick="closeModal('manageModal'); showRenameDialog();" style="width: 100%; margin-bottom: 10px; background: #667eea; color: white;">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ª–∏—Å—Ç</button>
      <button class="modal-button danger" onclick="closeModal('manageModal'); showDeleteDialog();" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ª–∏—Å—Ç</button>
      <button class="modal-button danger" onclick="clearAllData();" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-button cancel" onclick="closeModal('manageModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ–∞–π–ª–∞–º–∏ -->
  <div id="syncModal" class="modal">
    <div class="modal-content">
      <h3>üìÅ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞–º–∏</h3>
      <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 14px; color: #856404;">
        üì± <strong>–†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
      </div>
      
      <div style="display: grid; gap: 10px;">
        <button class="modal-button confirm" onclick="exportAllData(); closeModal('syncModal');" style="width: 100%;">
          üíæ <strong>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</strong><br>
          <small>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</small>
        </button>
        
        <button class="modal-button" onclick="importAllData(); closeModal('syncModal');" style="width: 100%; background: #48bb78; color: white;">
          üì• <strong>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</strong><br>
          <small>–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥—Ä—É–≥–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</small>
        </button>
        
        <button class="modal-button" onclick="shareViaText(); closeModal('syncModal');" style="width: 100%; background: #f39c12; color: white;">
          üì± <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º</strong><br>
          <small>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</small>
        </button>
        
        <button class="modal-button" onclick="showManageDialog(); closeModal('syncModal');" style="width: 100%; background: #6c757d; color: white;">
          ‚öôÔ∏è <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</strong><br>
          <small>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å –ª–∏—Å—Ç—ã, –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</small>
        </button>
      </div>
      
      <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
        üí° <strong>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong><br>
        1. <strong>–≠–∫—Å–ø–æ—Ä—Ç</strong> - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏<br>
        2. –ù–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç<br>
        3. <strong>–ò–º–ø–æ—Ä—Ç</strong> - –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª<br>
        4. –î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –Ω–∞ –Ω–æ–≤–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
      </div>
      
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-button cancel" onclick="closeModal('syncModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="modal-button primary" onclick="showCloudSync(); closeModal('syncModal');">‚òÅÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–ª–∞–∫–æ</button>
      </div>
    </div>
  </div>
  
  <div id="telegramSettingsModal" class="modal">
    <div class="modal-content">
      <h3>ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</label>
        <input type="text" id="botTokenInput" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" style="font-family: monospace; font-size: 14px;">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Chat ID:</label>
        <input type="text" id="chatIdInput" placeholder="-1234567890 –∏–ª–∏ 1234567890" style="font-family: monospace; font-size: 14px;">
      </div>
      <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
        <strong>üìã –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:</strong><br>
        1. –ù–∞–ø–∏—à–∏—Ç–µ @BotFather –≤ Telegram<br>
        2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ <code>/newbot</code><br>
        3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –ø–æ–ª—É—á–∏—Ç–µ <strong>—Ç–æ–∫–µ–Ω</strong><br>
        4. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É/–Ω–∞–ø–∏—à–∏—Ç–µ –µ–º—É<br>
        5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ<br>
        6. –û—Ç–∫—Ä–æ–π—Ç–µ: <code>api.telegram.org/bot{–¢–û–ö–ï–ù}/getUpdates</code><br>
        7. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ <strong>chat_id</strong> –∏–∑ –æ—Ç–≤–µ—Ç–∞
      </div>
      <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
        üîí <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∏–∫–æ–º—É.
      </div>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('telegramSettingsModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button confirm" onclick="saveTelegramSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
  <div id="cloudSyncModal" class="modal">
    <div class="modal-content">
      <h3>‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h3>
      
      <div id="cloudNotConfigured">
        <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; font-size: 14px; color: #1565c0;">
          üöÄ <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</strong><br>
          –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –æ–±–ª–∞–∫–µ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!
        </div>
        
        <div style="display: grid; gap: 10px;">
          <button class="modal-button confirm" onclick="showFirebaseSetup()" style="width: 100%;">
            üî• <strong>Firebase (Google)</strong><br>
            <small>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ, —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è, –¥–æ 1GB</small>
          </button>
          
          <button class="modal-button" onclick="showGitHubSetup()" style="width: 100%; background: #24292e; color: white;">
            üêô <strong>GitHub Gist</strong><br>
            <small>–í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –¥–ª—è GitHub –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
          </button>
          
          <button class="modal-button" onclick="showTelegramCloudSetup()" style="width: 100%; background: #0088cc; color: white;">
            üì± <strong>Telegram Storage</strong><br>
            <small>–ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–∞—à –±–æ—Ç –∫–∞–∫ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</small>
          </button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 12px; color: #666;">
          üí° <strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> Firebase - —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        </div>
      </div>

      <div id="cloudConfigured" style="display: none;">
        <div style="margin-bottom: 15px; padding: 15px; background: #d4edda; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span id="cloudStatusIcon">‚òÅÔ∏è</span>
            <strong id="cloudStatusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</strong>
          </div>
          <div style="font-size: 12px; color: #495057;">
            <div>–¢–∏–ø: <span id="cloudType">Firebase</span></div>
            <div>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="cloudUser">ID</span></div>
            <div>–°—Ç–∞—Ç—É—Å: <span id="cloudConnectionStatus">–û–Ω–ª–∞–π–Ω</span></div>
            <div id="cloudGistInfo" style="display: none;">
              <div>Gist ID: <span id="cloudGistId">-</span></div>
              <div><a id="cloudGistLink" href="#" target="_blank" style="color: #0366d6;">–û—Ç–∫—Ä—ã—Ç—å –≤ GitHub</a></div>
            </div>
          </div>
        </div>
        
        <div style="display: grid; gap: 10px;">
          <button class="modal-button confirm" onclick="manualCloudSync()" style="width: 100%;">
            üîÑ <strong>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</strong>
          </button>
          
          <button class="modal-button" onclick="testCloudConnection()" style="width: 100%; background: #17a2b8; color: white;">
            üß™ <strong>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</strong>
          </button>
          
          <button class="modal-button danger" onclick="disconnectCloud()" style="width: 100%;">
            üîå <strong>–û—Ç–∫–ª—é—á–∏—Ç—å –æ–±–ª–∞–∫–æ</strong>
          </button>
        </div>
      </div>
      
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-button cancel" onclick="closeModal('cloudSyncModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="modal-button" onclick="showSyncMenu()">üìÅ –§–∞–π–ª—ã</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase -->
  <div id="firebaseSetupModal" class="modal">
    <div class="modal-content">
      <h3>üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase</h3>
      
      <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
        <strong>üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
        1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://console.firebase.google.com" target="_blank" style="color: #856404;">console.firebase.google.com</a><br>
        2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç<br>
        3. Database ‚Üí Realtime Database ‚Üí –°–æ–∑–¥–∞—Ç—å<br>
        4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ ‚Üí –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí Web<br>
        5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—é–¥–∞
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Key:</label>
        <input type="text" id="firebaseApiKey" placeholder="AIzaSyC..." style="font-family: monospace; font-size: 14px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Database URL:</label>
        <input type="text" id="firebaseDatabaseURL" placeholder="https://your-project.firebaseio.com" style="font-family: monospace; font-size: 14px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Project ID:</label>
        <input type="text" id="firebaseProjectId" placeholder="your-project-id" style="font-family: monospace; font-size: 14px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–í–∞—à ID (–ª—é–±–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π):</label>
        <input type="text" id="firebaseUserId" placeholder="my-dispatcher-123" style="font-family: monospace; font-size: 14px;">
      </div>

      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('firebaseSetupModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button confirm" onclick="saveFirebaseSettings()">üî• –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Gist -->
  <div id="githubSetupModal" class="modal">
    <div class="modal-content">
      <h3>üêô –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Gist</h3>
      
      <div style="margin-bottom: 15px; padding: 15px; background: #f6f8fa; border-radius: 8px; font-size: 13px; color: #24292e; border-left: 4px solid #0366d6;">
        <strong>üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
        1. –û—Ç–∫—Ä–æ–π—Ç–µ <a href="https://github.com/settings/tokens" target="_blank" style="color: #0366d6;">github.com/settings/tokens</a><br>
        2. Generate new token ‚Üí Fine-grained tokens<br>
        3. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –≥–æ–¥)<br>
        4. Repository access: All repositories<br>
        5. Permissions: Contents (Read and write), Metadata (Read)<br>
        6. Generate token –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—é–¥–∞
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">GitHub Personal Access Token:</label>
        <input type="password" id="githubToken" placeholder="github_pat_11..." style="font-family: monospace; font-size: 14px;">
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          –¢–æ–∫–µ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Gist —Å –≤–∞—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        </div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π Gist ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
        <input type="text" id="githubGistId" placeholder="–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ" style="font-family: monospace; font-size: 14px;">
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          –ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å Gist —Å –¥–∞–Ω–Ω—ã–º–∏, –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ ID
        </div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
          <input type="checkbox" id="githubPrivate" checked>
          –ü—Ä–∏–≤–∞—Ç–Ω—ã–π Gist
        </label>
        <div style="font-size: 12px; color: #666; margin-top: 5px;">
          –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤–∞–º
        </div>
      </div>

      <div style="margin-bottom: 15px; padding: 10px; background: #d1ecf1; border-radius: 8px; font-size: 12px; color: #0c5460;">
        üí° <strong>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ GitHub Gist:</strong><br>
        ‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å)<br>
        ‚Ä¢ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å GitHub<br>
        ‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ<br>
        ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
      </div>

      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('githubSetupModal')">–û—Ç–º–µ–Ω–∞</button>
        <button class="modal-button" onclick="saveGitHubSettings()" style="background: #24292e; color: white;">üêô –ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentSheet = '';
    let selectedTasks = new Set();
    let tasksData = [];
    let allSheets = {};

    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const STORAGE_KEY = 'cargoDispatcher';
    const TELEGRAM_SETTINGS_KEY = 'cargoDispatcherTelegram';
    const FIREBASE_SETTINGS_KEY = 'cargoDispatcherFirebase';
    const GITHUB_SETTINGS_KEY = 'cargoDispatcherGitHub';
    const VERSION = '1.0';

    // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ localStorage —Å fallback
    let memoryStorage = {}; // Fallback —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤ –ø–∞–º—è—Ç–∏
    let isLocalStorageAvailable = false;

    function checkLocalStorage() {
      try {
        const test = 'test';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        isLocalStorageAvailable = true;
        logInfo('localStorage –¥–æ—Å—Ç—É–ø–µ–Ω');
        return true;
      } catch (error) {
        isLocalStorageAvailable = false;
        logError('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å', error);
        showStatus('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ—Å—Å–∏–∏ (localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)', 'error');
        return false;
      }
    }

    function safeSetItem(key, value) {
      try {
        if (isLocalStorageAvailable) {
          localStorage.setItem(key, value);
        } else {
          memoryStorage[key] = value;
        }
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', error);
        memoryStorage[key] = value; // Fallback
        return false;
      }
    }

    function safeGetItem(key) {
      try {
        if (isLocalStorageAvailable) {
          return localStorage.getItem(key);
        } else {
          return memoryStorage[key] || null;
        }
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', error);
        return memoryStorage[key] || null;
      }
    }

    function safeRemoveItem(key) {
      try {
        if (isLocalStorageAvailable) {
          localStorage.removeItem(key);
        } else {
          delete memoryStorage[key];
        }
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', error);
        delete memoryStorage[key]; // Fallback
        return false;
      }
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram (–±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage)
    let telegramSettings = {
      botToken: '',
      chatId: ''
    };

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase (–±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage)
    let firebaseSettings = {
      apiKey: '',
      databaseURL: '',
      projectId: '',
      userId: '', // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      enabled: false
    };

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Gist
    let githubSettings = {
      token: '',
      gistId: '',
      fileName: 'cargo-dispatcher-data.json',
      isPrivate: true,
      enabled: false
    };

    // Firebase –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let firebaseApp = null;
    let firebaseDB = null;
    let isOnline = false;
    let syncInProgress = false;

    // GitHub –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let githubSyncInProgress = false;
    let lastGitHubSync = 0;

    // –£—Ç–∏–ª–∏—Ç—ã
    function logError(message, error) {
      console.error(`[Cargo Dispatcher] ${message}:`, error);
    }

    function logInfo(message) {
      console.log(`[Cargo Dispatcher] ${message}`);
    }

    // –§—É–Ω–∫—Ü–∏–∏ localStorage
    function saveToStorage() {
      try {
        const data = {
          version: VERSION,
          sheets: allSheets,
          lastSaved: new Date().toISOString()
        };
        safeSetItem(STORAGE_KEY, JSON.stringify(data));
        logInfo('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', error);
        showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
        return false;
      }
    }

    function loadFromStorage() {
      try {
        const saved = safeGetItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.sheets) {
            allSheets = data.sheets;
            logInfo('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage');
            return true;
          }
        }
        return false;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', error);
        return false;
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram
    function loadTelegramSettings() {
      try {
        const saved = safeGetItem(TELEGRAM_SETTINGS_KEY);
        if (saved) {
          telegramSettings = JSON.parse(saved);
          logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          return true;
        }
        return false;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram', error);
        return false;
      }
    }

    function saveTelegramSettingsToStorage() {
      try {
        safeSetItem(TELEGRAM_SETTINGS_KEY, JSON.stringify(telegramSettings));
        logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram', error);
        return false;
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Firebase
    function loadFirebaseSettings() {
      try {
        const saved = safeGetItem(FIREBASE_SETTINGS_KEY);
        if (saved) {
          firebaseSettings = JSON.parse(saved);
          logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          return true;
        }
        return false;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Firebase', error);
        return false;
      }
    }

    function saveFirebaseSettingsToStorage() {
      try {
        safeSetItem(FIREBASE_SETTINGS_KEY, JSON.stringify(firebaseSettings));
        logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Firebase', error);
        return false;
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ GitHub
    function loadGitHubSettings() {
      try {
        const saved = safeGetItem(GITHUB_SETTINGS_KEY);
        if (saved) {
          githubSettings = JSON.parse(saved);
          logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          return true;
        }
        return false;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ GitHub', error);
        return false;
      }
    }

    function saveGitHubSettingsToStorage() {
      try {
        safeSetItem(GITHUB_SETTINGS_KEY, JSON.stringify(githubSettings));
        logInfo('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ GitHub', error);
        return false;
      }
    }

    // GitHub Gist API —Ñ—É–Ω–∫—Ü–∏–∏
    async function createGitHubGist(data) {
      const response = await fetch('https://api.github.com/gists', {
        method: 'POST',
        headers: {
          'Authorization': `token ${githubSettings.token}`,
          'Content-Type': 'application/json',
          'User-Agent': 'Cargo-Dispatcher-App'
        },
        body: JSON.stringify({
          description: '–î–∏—Å–ø–µ—Ç—á–µ—Ä –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫ - –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏',
          public: !githubSettings.isPrivate,
          files: {
            [githubSettings.fileName]: {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`GitHub API: ${response.status} - ${error}`);
      }

      return await response.json();
    }

    async function updateGitHubGist(gistId, data) {
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${githubSettings.token}`,
          'Content-Type': 'application/json',
          'User-Agent': 'Cargo-Dispatcher-App'
        },
        body: JSON.stringify({
          files: {
            [githubSettings.fileName]: {
              content: JSON.stringify(data, null, 2)
            }
          }
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`GitHub API: ${response.status} - ${error}`);
      }

      return await response.json();
    }

    async function getGitHubGist(gistId) {
      const response = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: {
          'Authorization': `token ${githubSettings.token}`,
          'User-Agent': 'Cargo-Dispatcher-App'
        }
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`GitHub API: ${response.status} - ${error}`);
      }

      return await response.json();
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å GitHub Gist
    async function syncToGitHub() {
      if (!githubSettings.enabled || !githubSettings.token || githubSyncInProgress) {
        return;
      }

      try {
        githubSyncInProgress = true;
        updateCloudStatus();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
        }

        const dataToSync = {
          version: VERSION,
          exportDate: new Date().toISOString(),
          lastModified: Date.now(),
          device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
          browser: navigator.userAgent,
          sheets: allSheets,
          telegramSettings: telegramSettings.botToken ? telegramSettings : null,
          currentSheet: currentSheet,
          totalTasks: Object.values(allSheets).flat().length,
          syncMethod: 'github-gist'
        };

        let result;
        if (githubSettings.gistId) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π gist
          result = await updateGitHubGist(githubSettings.gistId, dataToSync);
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π gist
          result = await createGitHubGist(dataToSync);
          githubSettings.gistId = result.id;
          saveGitHubSettingsToStorage();
        }

        lastGitHubSync = Date.now();
        safeSetItem(STORAGE_KEY + '_githubLastSync', lastGitHubSync.toString());

        logInfo('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ GitHub Gist: ' + result.html_url);
        showStatus('üêô –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å GitHub!', 'success');

      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub', error);
        
        if (error.message.includes('401')) {
          showStatus('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π GitHub —Ç–æ–∫–µ–Ω', 'error');
          githubSettings.enabled = false;
          saveGitHubSettingsToStorage();
        } else if (error.message.includes('404')) {
          showStatus('–û—à–∏–±–∫–∞: Gist –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π', 'error');
          githubSettings.gistId = '';
          saveGitHubSettingsToStorage();
        } else {
          showStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å GitHub: ' + error.message, 'error');
        }
      } finally {
        githubSyncInProgress = false;
        updateCloudStatus();
      }
    }

    async function syncFromGitHub() {
      if (!githubSettings.enabled || !githubSettings.token || !githubSettings.gistId) {
        return;
      }

      try {
        githubSyncInProgress = true;
        updateCloudStatus();

        const gist = await getGitHubGist(githubSettings.gistId);
        const fileContent = gist.files[githubSettings.fileName];
        
        if (!fileContent) {
          throw new Error('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Gist');
        }

        const cloudData = JSON.parse(fileContent.content);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
        const localLastSync = parseInt(safeGetItem(STORAGE_KEY + '_githubLastSync') || '0');
        const cloudLastModified = cloudData.lastModified || 0;
        
        if (cloudLastModified > localLastSync) {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
          const device = cloudData.device || '–¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
          const lastModified = new Date(cloudData.lastModified).toLocaleString('ru-RU');
          const totalTasks = cloudData.totalTasks || 0;
          
          const confirmText = `–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ GitHub:\n\nüì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device}\n‚è∞ –í—Ä–µ–º—è: ${lastModified}\nüìã –ó–∞–¥–∞–Ω–∏–π: ${totalTasks}\n\n–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å?`;
          
          if (confirm(confirmText)) {
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ GitHub
            allSheets = cloudData.sheets || {};
            
            if (cloudData.telegramSettings && cloudData.telegramSettings.botToken) {
              telegramSettings = cloudData.telegramSettings;
              saveTelegramSettingsToStorage();
            }
            
            const sheets = Object.keys(allSheets);
            if (sheets.length > 0) {
              currentSheet = cloudData.currentSheet || sheets[0];
              tasksData = [...(allSheets[currentSheet] || [])];
            } else {
              createInitialData();
            }
            
            updateSheetSelector();
            renderTasks();
            saveToStorage();
            
            lastGitHubSync = cloudData.lastModified;
            safeSetItem(STORAGE_KEY + '_githubLastSync', lastGitHubSync.toString());
            
            showStatus(`üêô –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å ${device}`, 'success');
            logInfo('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ GitHub Gist');
          }
        }

      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ GitHub', error);
        showStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ GitHub: ' + error.message, 'error');
      } finally {
        githubSyncInProgress = false;
        updateCloudStatus();
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub —Ç–æ–∫–µ–Ω–∞
    async function testGitHubConnection() {
      if (!githubSettings.token) {
        showStatus('GitHub —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω', 'error');
        return false;
      }

      try {
        showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è...', '');
        
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${githubSettings.token}`,
            'User-Agent': 'Cargo-Dispatcher-App'
          }
        });

        if (response.ok) {
          const user = await response.json();
          showStatus(`‚úÖ GitHub –ø–æ–¥–∫–ª—é—á–µ–Ω! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${user.login}`, 'success');
          return true;
        } else {
          showStatus('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π GitHub —Ç–æ–∫–µ–Ω', 'error');
          return false;
        }
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ GitHub', error);
        showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub', 'error');
        return false;
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    function initFirebase() {
      if (!firebaseSettings.enabled || !firebaseSettings.apiKey) return false;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Firebase SDK –∑–∞–≥—Ä—É–∂–µ–Ω
      if (typeof firebase === 'undefined') {
        logError('Firebase SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'Firebase –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        return false;
      }

      try {
        const config = {
          apiKey: firebaseSettings.apiKey,
          databaseURL: firebaseSettings.databaseURL,
          projectId: firebaseSettings.projectId
        };

        firebaseApp = firebase.initializeApp(config);
        firebaseDB = firebaseApp.database();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const connectedRef = firebaseDB.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
          isOnline = snapshot.val() === true;
          updateCloudStatus();
          
          if (isOnline && !syncInProgress) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
            syncToCloud();
          }
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –æ–±–ª–∞–∫–µ
        const userRef = firebaseDB.ref(`users/${firebaseSettings.userId}`);
        userRef.on('value', (snapshot) => {
          const cloudData = snapshot.val();
          if (cloudData && cloudData.lastModified && !syncInProgress) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è
            const localLastModified = safeGetItem(STORAGE_KEY + '_lastModified') || '0';
            if (cloudData.lastModified > localLastModified) {
              syncFromCloud(cloudData);
            }
          }
        });

        logInfo('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        return true;
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase', error);
        firebaseSettings.enabled = false;
        return false;
      }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –í –æ–±–ª–∞–∫–æ
    async function syncToCloud() {
      if (!firebaseDB || !firebaseSettings.enabled || syncInProgress || typeof firebase === 'undefined') return;

      try {
        syncInProgress = true;
        updateCloudStatus();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
        }

        const dataToSync = {
          version: VERSION,
          sheets: allSheets,
          telegramSettings: telegramSettings.botToken ? telegramSettings : null,
          currentSheet: currentSheet,
          lastModified: Date.now(),
          device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop'
        };

        await firebaseDB.ref(`users/${firebaseSettings.userId}`).set(dataToSync);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ
        safeSetItem(STORAGE_KEY + '_lastModified', dataToSync.lastModified.toString());
        
        logInfo('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ–±–ª–∞–∫–æ');
        showStatus('‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ –æ–±–ª–∞–∫–æ', 'success');
        
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –æ–±–ª–∞–∫–æ', error);
        showStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –æ–±–ª–∞–∫–æ', 'error');
      } finally {
        syncInProgress = false;
        updateCloudStatus();
      }
    }

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ò–ó –æ–±–ª–∞–∫–∞
    function syncFromCloud(cloudData) {
      if (syncInProgress) return;

      try {
        syncInProgress = true;
        updateCloudStatus();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        const device = cloudData.device || '–¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ';
        const lastModified = new Date(cloudData.lastModified).toLocaleString('ru-RU');
        
        if (confirm(`–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –±–æ–ª–µ–µ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞:\n\nüì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device}\n‚è∞ –í—Ä–µ–º—è: ${lastModified}\n\n–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å?`)) {
          // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞
          allSheets = cloudData.sheets || {};
          
          if (cloudData.telegramSettings && cloudData.telegramSettings.botToken) {
            telegramSettings = cloudData.telegramSettings;
            saveTelegramSettingsToStorage();
          }
          
          const sheets = Object.keys(allSheets);
          if (sheets.length > 0) {
            currentSheet = cloudData.currentSheet || sheets[0];
            tasksData = [...(allSheets[currentSheet] || [])];
          } else {
            createInitialData();
          }
          
          updateSheetSelector();
          renderTasks();
          saveToStorage();
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
          safeSetItem(STORAGE_KEY + '_lastModified', cloudData.lastModified.toString());
          
          showStatus(`‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å ${device}`, 'success');
          logInfo('–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
        }
        
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –æ–±–ª–∞–∫–∞', error);
        showStatus('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑ –æ–±–ª–∞–∫–∞', 'error');
      } finally {
        syncInProgress = false;
        updateCloudStatus();
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–ª–∞–∫–∞
    function updateCloudStatus() {
      const statusEl = document.getElementById('cloudStatus');
      const iconEl = document.getElementById('cloudIcon');
      const textEl = document.getElementById('cloudText');
      const btnEl = document.getElementById('cloudBtn');
      
      // –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      if (!statusEl || !iconEl || !textEl || !btnEl) {
        logError('–≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç–∞—Ç—É—Å–∞ –æ–±–ª–∞–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
      }
      
      const isCloudEnabled = firebaseSettings.enabled || githubSettings.enabled;
      
      if (!isCloudEnabled) {
        statusEl.style.display = 'none';
        btnEl.style.background = '#6c757d';
        return;
      }
      
      statusEl.style.display = 'flex';
      statusEl.className = 'cloud-status';
      
      if (syncInProgress || githubSyncInProgress) {
        statusEl.classList.add('syncing');
        iconEl.textContent = 'üîÑ';
        textEl.textContent = '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
        btnEl.style.background = '#f39c12';
      } else if (firebaseSettings.enabled && isOnline && typeof firebase !== 'undefined') {
        statusEl.classList.add('online');
        iconEl.textContent = 'üî•';
        textEl.textContent = 'Firebase';
        btnEl.style.background = '#48bb78';
      } else if (firebaseSettings.enabled && typeof firebase === 'undefined') {
        statusEl.classList.add('offline');
        iconEl.textContent = 'üî•';
        textEl.textContent = 'Firebase (–∑–∞–≥—Ä—É–∑–∫–∞)';
        btnEl.style.background = '#f39c12';
      } else if (githubSettings.enabled) {
        statusEl.classList.add('online');
        iconEl.textContent = 'üêô';
        textEl.textContent = 'GitHub';
        btnEl.style.background = '#24292e';
      } else {
        statusEl.classList.add('offline');
        iconEl.textContent = 'üì°';
        textEl.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω';
        btnEl.style.background = '#f56565';
      }
    }

    // UI —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–ª–∞–∫–∞
    function showCloudSync() {
      // –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      const modal = document.getElementById('cloudSyncModal');
      const notConfigured = document.getElementById('cloudNotConfigured');
      const configured = document.getElementById('cloudConfigured');
      
      if (!modal) {
        logError('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ cloudSyncModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
        showStatus('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
        return;
      }
      
      if (!notConfigured) {
        logError('–≠–ª–µ–º–µ–Ω—Ç cloudNotConfigured –Ω–µ –Ω–∞–π–¥–µ–Ω');
        showStatus('–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
        return;
      }
      
      if (!configured) {
        logError('–≠–ª–µ–º–µ–Ω—Ç cloudConfigured –Ω–µ –Ω–∞–π–¥–µ–Ω');
        showStatus('–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
        return;
      }
      
      const isCloudEnabled = firebaseSettings.enabled || githubSettings.enabled;
      
      if (isCloudEnabled) {
        notConfigured.style.display = 'none';
        configured.style.display = 'block';
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const typeEl = document.getElementById('cloudType');
        const userEl = document.getElementById('cloudUser');
        const statusEl = document.getElementById('cloudConnectionStatus');
        const iconEl = document.getElementById('cloudStatusIcon');
        const textEl = document.getElementById('cloudStatusText');
        const gistInfo = document.getElementById('cloudGistInfo');
        
        if (firebaseSettings.enabled) {
          if (typeEl) typeEl.textContent = 'Firebase';
          if (userEl) userEl.textContent = firebaseSettings.userId;
          if (statusEl) statusEl.textContent = isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω';
          if (iconEl) iconEl.textContent = isOnline ? 'üî•' : 'üì°';
          if (textEl) textEl.textContent = isOnline ? 'Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω' : 'Firebase –æ—Ñ—Ñ–ª–∞–π–Ω';
          if (gistInfo) gistInfo.style.display = 'none';
        } else if (githubSettings.enabled) {
          if (typeEl) typeEl.textContent = 'GitHub Gist';
          if (userEl) userEl.textContent = 'GitHub –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
          if (statusEl) statusEl.textContent = '–ì–æ—Ç–æ–≤';
          if (iconEl) iconEl.textContent = 'üêô';
          if (textEl) textEl.textContent = 'GitHub –ø–æ–¥–∫–ª—é—á–µ–Ω';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ Gist
          if (gistInfo) {
            if (githubSettings.gistId) {
              gistInfo.style.display = 'block';
              const gistIdEl = document.getElementById('cloudGistId');
              const gistLinkEl = document.getElementById('cloudGistLink');
              if (gistIdEl) gistIdEl.textContent = githubSettings.gistId;
              if (gistLinkEl) gistLinkEl.href = `https://gist.github.com/${githubSettings.gistId}`;
            } else {
              gistInfo.style.display = 'none';
            }
          }
        }
      } else {
        notConfigured.style.display = 'block';
        configured.style.display = 'none';
      }
      
      showModal('cloudSyncModal');
    }

    function showGitHubSetup() {
      closeModal('cloudSyncModal');
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      document.getElementById('githubToken').value = githubSettings.token || '';
      document.getElementById('githubGistId').value = githubSettings.gistId || '';
      document.getElementById('githubPrivate').checked = githubSettings.isPrivate;
      
      showModal('githubSetupModal');
    }

    async function saveGitHubSettings() {
      const token = document.getElementById('githubToken').value.trim();
      const gistId = document.getElementById('githubGistId').value.trim();
      const isPrivate = document.getElementById('githubPrivate').checked;
      
      if (!token) {
        showStatus('–í–≤–µ–¥–∏—Ç–µ GitHub —Ç–æ–∫–µ–Ω', 'error');
        return;
      }
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
      if (!token.startsWith('github_pat_') && !token.startsWith('ghp_')) {
        showStatus('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç GitHub —Ç–æ–∫–µ–Ω–∞', 'error');
        return;
      }
      
      githubSettings = {
        token,
        gistId,
        fileName: 'cargo-dispatcher-data.json',
        isPrivate,
        enabled: true
      };
      
      if (saveGitHubSettingsToStorage()) {
        closeModal('githubSetupModal');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const connected = await testGitHubConnection();
        if (connected) {
          showStatus('üêô GitHub –ø–æ–¥–∫–ª—é—á–µ–Ω! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'success');
          updateCloudStatus();
          
          // –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
          setTimeout(() => {
            if (gistId) {
              syncFromGitHub(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Gist
            } else {
              syncToGitHub(); // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Gist
            }
          }, 1000);
        } else {
          githubSettings.enabled = false;
          saveGitHubSettingsToStorage();
        }
      }
    }

    function showFirebaseSetup() {
      closeModal('cloudSyncModal');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º Firebase SDK –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      if (typeof firebase === 'undefined') {
        showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ Firebase SDK...', '');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase SDK –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        const script1 = document.createElement('script');
        script1.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
        script1.onload = function() {
          const script2 = document.createElement('script');
          script2.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js';
          script2.onload = function() {
            showStatus('Firebase SDK –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            openFirebaseSetupModal();
          };
          script2.onerror = function() {
            showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase SDK', 'error');
          };
          document.head.appendChild(script2);
        };
        script1.onerror = function() {
          showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase SDK', 'error');
        };
        document.head.appendChild(script1);
      } else {
        openFirebaseSetupModal();
      }
    }

    function openFirebaseSetupModal() {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      document.getElementById('firebaseApiKey').value = firebaseSettings.apiKey || '';
      document.getElementById('firebaseDatabaseURL').value = firebaseSettings.databaseURL || '';
      document.getElementById('firebaseProjectId').value = firebaseSettings.projectId || '';
      document.getElementById('firebaseUserId').value = firebaseSettings.userId || 'user_' + Date.now();
      
      showModal('firebaseSetupModal');
    }

    function saveFirebaseSettings() {
      const apiKey = document.getElementById('firebaseApiKey').value.trim();
      const databaseURL = document.getElementById('firebaseDatabaseURL').value.trim();
      const projectId = document.getElementById('firebaseProjectId').value.trim();
      const userId = document.getElementById('firebaseUserId').value.trim();
      
      if (!apiKey || !databaseURL || !projectId || !userId) {
        showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
      if (!apiKey.startsWith('AIza') || !databaseURL.includes('firebaseio.com')) {
        showStatus('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö Firebase', 'error');
        return;
      }
      
      firebaseSettings = {
        apiKey,
        databaseURL,
        projectId,
        userId,
        enabled: true
      };
      
      if (saveFirebaseSettingsToStorage()) {
        closeModal('firebaseSetupModal');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase
        if (initFirebase()) {
          showStatus('üî• Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω! –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'success');
          updateCloudStatus();
          
          // –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
          setTimeout(() => {
            syncToCloud();
          }, 1000);
        } else {
          showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase', 'error');
        }
      }
    }

    function disconnectCloud() {
      const cloudType = firebaseSettings.enabled ? 'Firebase' : githubSettings.enabled ? 'GitHub' : '–æ–±–ª–∞—á–Ω—É—é';
      
      if (!confirm(`–û—Ç–∫–ª—é—á–∏—Ç—å ${cloudType} —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é? –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.`)) {
        return;
      }
      
      if (firebaseSettings.enabled) {
        firebaseSettings.enabled = false;
        saveFirebaseSettingsToStorage();
        
        // –û—Ç–∫–ª—é—á–∞–µ–º Firebase
        if (firebaseApp && typeof firebase !== 'undefined') {
          try {
            firebaseApp.delete();
          } catch (error) {
            logError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è Firebase', error);
          }
        }
        
        firebaseApp = null;
        firebaseDB = null;
        isOnline = false;
      }
      
      if (githubSettings.enabled) {
        githubSettings.enabled = false;
        saveGitHubSettingsToStorage();
      }
      
      updateCloudStatus();
      closeModal('cloudSyncModal');
      showStatus('‚òÅÔ∏è –û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞', 'success');
    }

    function manualCloudSync() {
      if (firebaseSettings.enabled) {
        syncToCloud();
      } else if (githubSettings.enabled) {
        syncToGitHub();
      } else {
        showStatus('–û–±–ª–∞–∫–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ', 'error');
      }
    }

    function testCloudConnection() {
      if (firebaseSettings.enabled && firebaseDB && typeof firebase !== 'undefined') {
        showStatus('–ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase...', '');
        
        firebaseDB.ref('.info/connected').once('value')
          .then((snapshot) => {
            const connected = snapshot.val();
            if (connected) {
              showStatus('‚úÖ Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
            } else {
              showStatus('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase', 'error');
            }
          })
          .catch((error) => {
            logError('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Firebase', error);
            showStatus('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Firebase', 'error');
          });
      } else if (githubSettings.enabled) {
        testGitHubConnection();
      } else {
        showStatus('–û–±–ª–∞–∫–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ', 'error');
      }
    }

    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è Telegram Storage
    function showTelegramCloudSetup() {
      showStatus('üöß Telegram Storage —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!', 'error');
      closeModal('cloudSyncModal');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
    function showSyncMenu() {
      closeModal('cloudSyncModal');
      showModal('syncModal');
    }

    function createInitialData() {
      const today = new Date().toLocaleDateString('ru-RU');
      allSheets = {
        [today]: [
          {
            machines: '107',
            orders: [{
              cargo: '–ø–µ—Å–æ–∫',
              from: '—Å–µ–ª—ã—á–∫–∞',
              to: '–∑–∞–≤—å—è–ª–æ–≤–æ', 
              customer: '–û–û–û –°–æ—é–∑–ø—Ä–æ–º—Å–∏—Ä–æ–π',
              note: '–ø—Ä–∏–º–µ—Ä –∑–∞–∫–∞–∑–∞'
            }]
          }
        ]
      };
      currentSheet = today;
      tasksData = [...allSheets[currentSheet]];
      logInfo('–°–æ–∑–¥–∞–Ω—ã –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function init() {
      logInfo('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å localStorage
      checkLocalStorage();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      if (!loadFromStorage()) {
        createInitialData();
        saveToStorage();
      } else {
        // –í—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏—Å—Ç
        const sheets = Object.keys(allSheets).sort().reverse();
        if (sheets.length > 0) {
          currentSheet = sheets[0];
          tasksData = [...allSheets[currentSheet]];
        } else {
          createInitialData();
        }
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
      loadTelegramSettings();
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
      loadFirebaseSettings();
      if (firebaseSettings.enabled) {
        initFirebase();
      }

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub
      loadGitHubSettings();
      if (githubSettings.enabled) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º GitHub –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        setTimeout(() => {
          syncFromGitHub();
        }, 2000);
      }

      updateSheetSelector();
      renderTasks();
      setupEventListeners();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–ª–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
      setTimeout(() => {
        updateCloudStatus();
      }, 100);
      
      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –æ–±–ª–∞–∫–æ
      setInterval(() => {
        if (currentSheet && allSheets[currentSheet]) {
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –æ–±–ª–∞–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
          if (firebaseSettings.enabled && isOnline && !syncInProgress && typeof firebase !== 'undefined') {
            syncToCloud();
          } else if (githubSettings.enabled && !githubSyncInProgress) {
            // GitHub —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–∂–µ (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
            const timeSinceLastSync = Date.now() - lastGitHubSync;
            if (timeSinceLastSync > 120000) { // 2 –º–∏–Ω—É—Ç—ã
              syncToGitHub();
            }
          }
        }
      }, 30000);

      logInfo('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function setupEventListeners() {
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      window.addEventListener('beforeunload', () => {
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 's':
              e.preventDefault();
              saveData();
              break;
            case 'n':
              e.preventDefault();
              addNewTask();
              break;
          }
        }
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ª–∏—Å—Ç–æ–≤
    function updateSheetSelector() {
      const selector = document.getElementById('sheetSelector');
      const sheets = Object.keys(allSheets).sort().reverse();
      
      selector.innerHTML = '<option value="_new">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –¥–∞—Ç—É</option>' +
        sheets.map(sheet => 
          `<option value="${sheet}" ${sheet === currentSheet ? 'selected' : ''}>${sheet}</option>`
        ).join('');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞
    function loadSheet() {
      const sheetName = document.getElementById('sheetSelector').value;
      
      if (sheetName === '_new') {
        document.getElementById('sheetSelector').value = currentSheet;
        showModal('createModal');
        return;
      }
      
      if (!sheetName || !allSheets[sheetName]) return;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      if (currentSheet && allSheets[currentSheet]) {
        allSheets[currentSheet] = [...tasksData];
      }
      
      currentSheet = sheetName;
      tasksData = [...allSheets[currentSheet]];
      renderTasks();
      saveToStorage();
      showStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω –ª–∏—Å—Ç: ${sheetName}`, 'success');
    }

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–¥–∞–Ω–∏–π
    function renderTasks() {
      const container = document.getElementById('tasksContainer');
      const helpTip = document.getElementById('navigationTip');
      container.innerHTML = '';
      selectedTasks.clear();
      
      if (tasksData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">üìã</div>
            <div>–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑!</div>
          </div>
        `;
        if (helpTip) helpTip.style.display = 'none';
        return;
      }
      
      tasksData.forEach((task, index) => {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–∂–µ –ø—É—Å—Ç—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const taskCard = createTaskCard(task, index);
        container.appendChild(taskCard);
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      if (helpTip) helpTip.style.display = 'block';
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞–Ω–∏—è
    function createTaskCard(taskData, index) {
      const card = document.createElement('div');
      card.className = 'task-card';
      card.dataset.index = index;
      
      let html = `
        <div class="machine-header">
          <div style="flex: 1; display: flex; align-items: center;">
            <span style="color: red; font-size: 24px; margin-right: 5px;">*</span>
            <div class="machine-name" contenteditable="true" data-field="machines">${taskData.machines ? 'üöõ ' + taskData.machines : ''}</div>
          </div>
          <input type="checkbox" class="select-checkbox" onchange="toggleSelection(${index})">
        </div>
        <div class="sub-orders">
      `;
      
      taskData.orders.forEach((order, orderIndex) => {
        html += `
          <div class="sub-order" data-order-index="${orderIndex}">
            <div class="sub-order-header">
              <span>–ó–∞–∫–∞–∑ ${orderIndex + 1}</span>
              ${taskData.orders.length > 1 ? 
                `<button class="remove-sub-order" onclick="removeSubOrder(${index}, ${orderIndex})">√ó</button>` : ''}
            </div>
            <div class="task-detail">
              <span class="label">üì¶ –ì—Ä—É–∑:</span>
              <div class="value" contenteditable="true" data-field="cargo" data-order="${orderIndex}" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥—Ä—É–∑">${order.cargo || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">üìç –û—Ç–∫—É–¥–∞:</span>
              <div class="value" contenteditable="true" data-field="from" data-order="${orderIndex}" placeholder="–ú–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏">${order.from || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">üìç –ö—É–¥–∞:</span>
              <div class="value" contenteditable="true" data-field="to" data-order="${orderIndex}" placeholder="–ú–µ—Å—Ç–æ –≤—ã–≥—Ä—É–∑–∫–∏">${order.to || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">üë§ –ó–∞–∫–∞–∑—á–∏–∫:</span>
              <div class="value" contenteditable="true" data-field="customer" data-order="${orderIndex}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">${order.customer || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">üìù –ó–∞–º–µ—Ç–∫–∞:</span>
              <div class="value" contenteditable="true" data-field="note" data-order="${orderIndex}" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è">${order.note || ''}</div>
            </div>
          </div>
        `;
      });
      
      html += `
          <button class="add-sub-order-btn" onclick="addSubOrder(${index})">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ –¥–ª—è —ç—Ç–∏—Ö –º–∞—à–∏–Ω</button>
        </div>
      `;
      
      card.innerHTML = html;
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
      card.querySelectorAll('[contenteditable]').forEach(elem => {
        elem.addEventListener('input', () => updateTaskData(index, elem));
        elem.addEventListener('blur', () => {
          // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
          
          // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫–∞—Ä—Ç–æ—á–∫–∏
          card.classList.remove('editing');
        });
        
        elem.addEventListener('focus', () => {
          // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ
          card.classList.add('editing');
        });
        
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–æ–ª—è–º
        elem.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            moveToNextField(elem);
          } else if (e.key === 'Tab') {
            // Tab —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞
            e.preventDefault();
            if (e.shiftKey) {
              moveToPrevField(elem);
            } else {
              moveToNextField(elem);
            }
          }
        });
      });
      
      return card;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è
    function updateTaskData(index, element) {
      if (!tasksData[index]) return;
      
      const field = element.dataset.field;
      const orderIndex = element.dataset.order;
      const value = element.textContent.trim();
      
      if (field === 'machines') {
        tasksData[index].machines = value;
      } else if (orderIndex !== undefined && tasksData[index].orders[orderIndex]) {
        tasksData[index].orders[orderIndex][field] = value;
      }
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
    function moveToNextField(currentElement) {
      const field = currentElement.dataset.field;
      const orderIndex = currentElement.dataset.order;
      const taskCard = currentElement.closest('.task-card');
      const taskIndex = parseInt(taskCard.dataset.index);
      
      let nextElement = null;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–µ–µ –ø–æ–ª–µ
      if (field === 'machines') {
        // –û—Ç –º–∞—à–∏–Ω –∫ –ø–µ—Ä–≤–æ–º—É –≥—Ä—É–∑—É
        nextElement = taskCard.querySelector('[data-field="cargo"][data-order="0"]');
      } else if (field === 'cargo') {
        // –û—Ç –≥—Ä—É–∑–∞ –∫ –æ—Ç–∫—É–¥–∞
        nextElement = taskCard.querySelector(`[data-field="from"][data-order="${orderIndex}"]`);
      } else if (field === 'from') {
        // –û—Ç –æ—Ç–∫—É–¥–∞ –∫ –∫—É–¥–∞
        nextElement = taskCard.querySelector(`[data-field="to"][data-order="${orderIndex}"]`);
      } else if (field === 'to') {
        // –û—Ç –∫—É–¥–∞ –∫ –∑–∞–∫–∞–∑—á–∏–∫—É
        nextElement = taskCard.querySelector(`[data-field="customer"][data-order="${orderIndex}"]`);
      } else if (field === 'customer') {
        // –û—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞ –∫ –∑–∞–º–µ—Ç–∫–µ
        nextElement = taskCard.querySelector(`[data-field="note"][data-order="${orderIndex}"]`);
      } else if (field === 'note') {
        // –û—Ç –∑–∞–º–µ—Ç–∫–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∑–∞–∫–∞–∑—É –∏–ª–∏ –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ
        const nextOrderIndex = parseInt(orderIndex) + 1;
        nextElement = taskCard.querySelector(`[data-field="cargo"][data-order="${nextOrderIndex}"]`);
        
        if (!nextElement) {
          // –ú–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ —Ç–æ–π –∂–µ –∫–∞—Ä—Ç–æ—á–∫–µ –µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—à–∏–Ω—ã
          const machinesField = taskCard.querySelector('[data-field="machines"]');
          if (machinesField && machinesField.textContent.trim()) {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –≤ —Ç–µ–∫—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
            addSubOrder(taskIndex);
            setTimeout(() => {
              const newOrder = taskCard.querySelector(`[data-field="cargo"][data-order="${nextOrderIndex}"]`);
              if (newOrder) {
                newOrder.focus();
                showStatus('‚ûï –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑', 'success');
              }
            }, 100);
            return;
          } else {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
            const nextTaskCard = document.querySelector(`.task-card[data-index="${taskIndex + 1}"]`);
            if (nextTaskCard) {
              nextElement = nextTaskCard.querySelector('[data-field="machines"]');
            } else {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
              addNewTask();
              setTimeout(() => {
                const newCard = document.querySelector(`.task-card[data-index="${tasksData.length - 1}"]`);
                if (newCard) {
                  nextElement = newCard.querySelector('[data-field="machines"]');
                  if (nextElement) nextElement.focus();
                }
              }, 100);
              return;
            }
          }
        }
      }
      
      if (nextElement) {
        nextElement.focus();
        
        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        nextElement.style.animation = 'focusGlow 0.5s ease-out';
        setTimeout(() => {
          nextElement.style.animation = '';
        }, 500);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
        if (nextElement.textContent) {
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(nextElement);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }
    
    function moveToPrevField(currentElement) {
      const field = currentElement.dataset.field;
      const orderIndex = currentElement.dataset.order;
      const taskCard = currentElement.closest('.task-card');
      const taskIndex = parseInt(taskCard.dataset.index);
      
      let prevElement = null;
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –ø–æ–ª–µ
      if (field === 'cargo' && orderIndex === '0') {
        // –û—Ç –ø–µ—Ä–≤–æ–≥–æ –≥—Ä—É–∑–∞ –∫ –º–∞—à–∏–Ω–∞–º
        prevElement = taskCard.querySelector('[data-field="machines"]');
      } else if (field === 'cargo') {
        // –û—Ç –≥—Ä—É–∑–∞ –∫ –∑–∞–º–µ—Ç–∫–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–∫–∞–∑–∞
        const prevOrderIndex = parseInt(orderIndex) - 1;
        prevElement = taskCard.querySelector(`[data-field="note"][data-order="${prevOrderIndex}"]`);
      } else if (field === 'from') {
        // –û—Ç –æ—Ç–∫—É–¥–∞ –∫ –≥—Ä—É–∑—É
        prevElement = taskCard.querySelector(`[data-field="cargo"][data-order="${orderIndex}"]`);
      } else if (field === 'to') {
        // –û—Ç –∫—É–¥–∞ –∫ –æ—Ç–∫—É–¥–∞
        prevElement = taskCard.querySelector(`[data-field="from"][data-order="${orderIndex}"]`);
      } else if (field === 'customer') {
        // –û—Ç –∑–∞–∫–∞–∑—á–∏–∫–∞ –∫ –∫—É–¥–∞
        prevElement = taskCard.querySelector(`[data-field="to"][data-order="${orderIndex}"]`);
      } else if (field === 'note') {
        // –û—Ç –∑–∞–º–µ—Ç–∫–∏ –∫ –∑–∞–∫–∞–∑—á–∏–∫—É
        prevElement = taskCard.querySelector(`[data-field="customer"][data-order="${orderIndex}"]`);
      } else if (field === 'machines') {
        // –û—Ç –º–∞—à–∏–Ω –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
        const prevTaskCard = document.querySelector(`.task-card[data-index="${taskIndex - 1}"]`);
        if (prevTaskCard) {
          // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–ª–µ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
          const lastSubOrder = prevTaskCard.querySelector('.sub-order:last-child');
          if (lastSubOrder) {
            prevElement = lastSubOrder.querySelector('[data-field="note"]');
          }
        }
      }
      
      if (prevElement) {
        prevElement.focus();
        
        // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        prevElement.style.animation = 'focusGlow 0.5s ease-out';
        setTimeout(() => {
          prevElement.style.animation = '';
        }, 500);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –≤ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞
        if (prevElement.textContent) {
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(prevElement);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }

    // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–∫–∞–∑
    function addSubOrder(taskIndex) {
      if (!tasksData[taskIndex]) return;
      
      tasksData[taskIndex].orders.push({
        cargo: '',
        from: '',
        to: '',
        customer: '',
        note: ''
      });
      
      renderTasks();
      
      setTimeout(() => {
        const card = document.querySelector(`.task-card[data-index="${taskIndex}"]`);
        if (card) {
          const newOrder = card.querySelector('.sub-order:last-child');
          if (newOrder) {
            newOrder.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const firstInput = newOrder.querySelector('[data-field="cargo"]');
            if (firstInput) firstInput.focus();
          }
        }
      }, 100);
    }

    // –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–∑–∞–∫–∞–∑
    function removeSubOrder(taskIndex, orderIndex) {
      if (!tasksData[taskIndex] || tasksData[taskIndex].orders.length <= 1) return;
      
      tasksData[taskIndex].orders.splice(orderIndex, 1);
      renderTasks();
      showStatus('–ó–∞–∫–∞–∑ —É–¥–∞–ª–µ–Ω', 'success');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è
    function toggleSelection(index) {
      const card = document.querySelector(`.task-card[data-index="${index}"]`);
      if (!card) return;
      
      if (selectedTasks.has(index)) {
        selectedTasks.delete(index);
        card.classList.remove('selected');
      } else {
        selectedTasks.add(index);
        card.classList.add('selected');
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
    function addNewTask() {
      const newTask = {
        machines: '',
        orders: [{
          cargo: '',
          from: '',
          to: '',
          customer: '',
          note: ''
        }]
      };
      
      tasksData.push(newTask);
      renderTasks();
      
      setTimeout(() => {
        const newCard = document.querySelector(`.task-card[data-index="${tasksData.length - 1}"]`);
        if (newCard) {
          const machineInput = newCard.querySelector('[data-field="machines"]');
          if (machineInput) {
            machineInput.focus();
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }, 100);
      
      showStatus('–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑', 'success');
    }

    // –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
    function duplicateSelected() {
      if (selectedTasks.size === 0) {
        showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        if (tasksData[index]) {
          const original = tasksData[index];
          const duplicate = {
            machines: '',
            orders: original.orders.map(order => ({...order}))
          };
          tasksData.splice(index + 1, 0, duplicate);
        }
      });
      
      renderTasks();
      showStatus(`–ü—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–æ –∑–∞–¥–∞–Ω–∏–π: ${indices.length}`, 'success');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è
    function deleteSelected() {
      if (selectedTasks.size === 0) {
        showStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
        return;
      }
      
      if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è (${selectedTasks.size} —à—Ç.)?`)) {
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        if (tasksData[index]) {
          tasksData.splice(index, 1);
        }
      });
      
      renderTasks();
      showStatus('–ó–∞–¥–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã', 'success');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function saveData() {
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –º–∞—à–∏–Ω—ã
      const emptyMachines = tasksData.filter(t => 
        !t.machines && t.orders.some(o => o.cargo || o.from || o.to || o.customer)
      );
      
      if (emptyMachines.length > 0) {
        showStatus('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –º–∞—à–∏–Ω –≤–æ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–∞—Ö!', 'error');
        
        // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –ø—É—Å—Ç—ã–µ –ø–æ–ª—è
        document.querySelectorAll('.machine-name').forEach(el => {
          if (!el.textContent.trim()) {
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 500);
          }
        });
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
      allSheets[currentSheet] = [...tasksData];
      
      if (saveToStorage()) {
        showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ –æ–±–ª–∞–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
        if (firebaseSettings.enabled && isOnline && !syncInProgress && typeof firebase !== 'undefined') {
          setTimeout(() => {
            syncToCloud();
          }, 500);
        } else if (githubSettings.enabled && !githubSyncInProgress) {
          setTimeout(() => {
            syncToGitHub();
          }, 500);
        }
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
    async function sendToTelegram() {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
      if (!telegramSettings.botToken || !telegramSettings.chatId) {
        showStatus('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö', 'error');
        setTimeout(() => showTelegramSettings(), 1000);
        return;
      }

      const message = formatForTelegram();
      
      if (!message.trim()) {
        showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', 'error');
        return;
      }
      
      showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram...');
      
      try {
        const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            chat_id: telegramSettings.chatId,
            text: message,
            parse_mode: 'HTML',
            disable_web_page_preview: true
          })
        });
        
        const result = await response.json();
        
        if (!result.ok) {
          throw new Error(result.description || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
        }
        
        showStatus('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
        
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram', error);
        
        if (error.message.includes('chat not found') || error.message.includes('Forbidden')) {
          showStatus('–û—à–∏–±–∫–∞: –ë–æ—Ç –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–∞—Ç –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω', 'error');
        } else if (error.message.includes('token') || error.message.includes('Unauthorized')) {
          showStatus('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          showStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç', 'error');
        } else {
          showStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message, 'error');
        }
      }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
    function showTelegramSettings() {
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      document.getElementById('botTokenInput').value = telegramSettings.botToken || '';
      document.getElementById('chatIdInput').value = telegramSettings.chatId || '';
      
      showModal('telegramSettingsModal');
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
    function saveTelegramSettings() {
      const botToken = document.getElementById('botTokenInput').value.trim();
      const chatId = document.getElementById('chatIdInput').value.trim();
      
      if (!botToken || !chatId) {
        showStatus('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
        return;
      }
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
      if (!botToken.includes(':') || botToken.length < 20) {
        showStatus('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞', 'error');
        return;
      }
      
      // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è chat ID
      if (!/^-?\d+$/.test(chatId)) {
        showStatus('Chat ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º', 'error');
        return;
      }
      
      telegramSettings.botToken = botToken;
      telegramSettings.chatId = chatId;
      
      if (saveTelegramSettingsToStorage()) {
        closeModal('telegramSettingsModal');
        showStatus('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
      } else {
        showStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
      }
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram (—Å HTML —Ä–∞–∑–º–µ—Ç–∫–æ–π)
    function formatForTelegram() {
      const activeTasks = tasksData.filter(task => task.machines);
      
      if (activeTasks.length === 0) {
        return `üìÖ <b>${currentSheet}</b>\n\n–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.`;
      }
      
      let message = `üìÖ <b>${currentSheet}</b>\n\n`;
      
      activeTasks.forEach((task, taskIndex) => {
        message += `üöõ <b>${task.machines}</b>\n`;
        
        task.orders.forEach((order, orderIndex) => {
          if (task.orders.length > 1) {
            message += `  ${orderIndex + 1}. `;
          } else {
            message += `  `;
          }
          
          message += `üì¶ ${order.cargo || '-'} | `;
          message += `üìç ${order.from || '?'} ‚Üí ${order.to || '?'} | `;
          message += `üë§ ${order.customer || '-'}`;
          
          if (order.note) {
            message += `\n     üìù <i>${order.note}</i>`;
          }
          message += '\n';
        });
        
        message += '\n';
      });
      
      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)
      if (message.length > 4000) {
        message = message.substring(0, 3997) + "...";
      }
      
      return message.trim();
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    function exportAllData() {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
        }

        const data = {
          version: VERSION,
          exportDate: new Date().toISOString(),
          device: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
          sheets: allSheets,
          telegramSettings: telegramSettings,
          currentSheet: currentSheet,
          totalTasks: Object.values(allSheets).flat().length
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const deviceName = navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop';
        const dateStr = new Date().toISOString().split('T')[0];
        a.download = `cargo-dispatcher-${deviceName}-${dateStr}.json`;
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ó–∞–≥—Ä—É–∑–∫–∏', 'success');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        setTimeout(() => {
          showStatus('üí° –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ç–∞–º', 'success');
        }, 3000);
        
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', error);
        showStatus('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
      }
    }

    // –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    function importAllData() {
      document.getElementById('dataImportInput').click();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞
    function handleDataImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (!data.sheets) {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
          const totalTasks = Object.values(data.sheets).flat().length;
          const exportDate = new Date(data.exportDate).toLocaleDateString('ru-RU');
          const device = data.device || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
          
          const confirmText = `–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?\n\nüìä –õ–∏—Å—Ç–æ–≤: ${Object.keys(data.sheets).length}\nüìã –ó–∞–¥–∞–Ω–∏–π: ${totalTasks}\nüìÖ –≠–∫—Å–ø–æ—Ä—Ç: ${exportDate}\nüì± –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device}\n\n‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã!`;
          
          if (confirm(confirmText)) {
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
            allSheets = data.sheets || {};
            
            // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram –µ—Å–ª–∏ –µ—Å—Ç—å
            if (data.telegramSettings && data.telegramSettings.botToken) {
              telegramSettings = data.telegramSettings;
              saveTelegramSettingsToStorage();
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º –ª–∏—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const sheets = Object.keys(allSheets);
            if (sheets.length > 0) {
              currentSheet = data.currentSheet || sheets[0];
              tasksData = [...(allSheets[currentSheet] || [])];
            } else {
              createInitialData();
            }
            
            updateSheetSelector();
            renderTasks();
            saveToStorage();
            
            showStatus(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ${Object.keys(allSheets).length} –ª–∏—Å—Ç–æ–≤, ${totalTasks} –∑–∞–¥–∞–Ω–∏–π`, 'success');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—ã–ª–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
            setTimeout(() => {
              const telegramImported = data.telegramSettings ? ' + –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram' : '';
              showStatus(`üì± –î–∞–Ω–Ω—ã–µ —Å ${device} —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã${telegramImported}`, 'success');
            }, 3000);
          }
        } catch (error) {
          logError('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', error);
          showStatus('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞', 'error');
        }
        
        // –û—á–∏—â–∞–µ–º input
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }

    // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–æ–º
    function shareViaText() {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
        }

        const data = {
          version: VERSION,
          exportDate: new Date().toISOString(),
          sheets: allSheets,
          telegramSettings: telegramSettings.botToken ? telegramSettings : null,
          currentSheet: currentSheet
        };
        
        const compressedData = JSON.stringify(data);
        const totalTasks = Object.values(allSheets).flat().length;
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const shareText = `üìã –î–∏—Å–ø–µ—Ç—á–µ—Ä –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–æ–∫ - –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

üìä –õ–∏—Å—Ç–æ–≤: ${Object.keys(allSheets).length}
üìã –ó–∞–¥–∞–Ω–∏–π: ${totalTasks}
üìÖ –≠–∫—Å–ø–æ—Ä—Ç: ${new Date().toLocaleDateString('ru-RU')}

üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: ${window.location.href}

üì¶ –î–∞–Ω–Ω—ã–µ (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –≤ —Ñ–∞–π–ª .json):
${compressedData}`;

        // –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        if (navigator.clipboard) {
          navigator.clipboard.writeText(shareText)
            .then(() => {
              showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ', 'success');
              setTimeout(() => {
                showStatus('üí° –ù–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .json –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ', 'success');
              }, 3000);
            })
            .catch(() => fallbackCopyShare(shareText));
        } else {
          fallbackCopyShare(shareText);
        }
        
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏', error);
        showStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
      }
    }

    function fallbackCopyShare(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        showStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã! –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ', 'success');
      } catch (error) {
        showStatus('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞', 'error');
      }
      
      document.body.removeChild(textarea);
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    function clearAllData() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        return;
      }
      
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –ª–∏—Å—Ç—ã, –∑–∞–¥–∞–Ω–∏—è –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (Telegram + Firebase + GitHub) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
        return;
      }
      
      try {
        safeRemoveItem(STORAGE_KEY);
        safeRemoveItem(TELEGRAM_SETTINGS_KEY);
        safeRemoveItem(FIREBASE_SETTINGS_KEY);
        safeRemoveItem(GITHUB_SETTINGS_KEY);
        safeRemoveItem(STORAGE_KEY + '_lastModified');
        safeRemoveItem(STORAGE_KEY + '_githubLastSync');
        
        allSheets = {};
        tasksData = [];
        currentSheet = '';
        telegramSettings = { botToken: '', chatId: '' };
        firebaseSettings = { apiKey: '', databaseURL: '', projectId: '', userId: '', enabled: false };
        githubSettings = { token: '', gistId: '', fileName: 'cargo-dispatcher-data.json', isPrivate: true, enabled: false };
        
        // –û—Ç–∫–ª—é—á–∞–µ–º Firebase
        if (firebaseApp && typeof firebase !== 'undefined') {
          try {
            firebaseApp.delete();
          } catch (error) {
            logError('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è Firebase –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ', error);
          }
        }
        
        firebaseApp = null;
        firebaseDB = null;
        isOnline = false;
        githubSyncInProgress = false;
        lastGitHubSync = 0;
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
        createInitialData();
        updateSheetSelector();
        renderTasks();
        saveToStorage();
        updateCloudStatus();
        
        showStatus('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
      } catch (error) {
        logError('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', error);
        showStatus('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
      }
    }

    // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    function copyToClipboard() {
      const message = formatForClipboard();
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(message)
          .then(() => showStatus('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success'))
          .catch(() => fallbackCopy(message));
      } else {
        fallbackCopy(message);
      }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        showStatus('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
      } catch (error) {
        showStatus('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
      }
      
      document.body.removeChild(textarea);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
    function formatForClipboard() {
      let message = `üìÖ ${currentSheet}\n\n`;
      
      const activeTasks = tasksData.filter(task => task.machines);
      
      if (activeTasks.length === 0) {
        message += '–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ —ç—Ç—É –¥–∞—Ç—É.\n';
        return message;
      }
      
      activeTasks.forEach((task, taskIndex) => {
        message += `üöõ ${task.machines}\n`;
        
        task.orders.forEach((order, orderIndex) => {
          if (task.orders.length > 1) {
            message += `  ${orderIndex + 1}. `;
          } else {
            message += `  `;
          }
          
          message += `üì¶ ${order.cargo || '-'} | `;
          message += `üìç ${order.from || '?'} ‚Üí ${order.to || '?'} | `;
          message += `üë§ ${order.customer || '-'}`;
          
          if (order.note) {
            message += `\n     üìù ${order.note}`;
          }
          message += '\n';
        });
        
        message += '\n';
      });
      
      return message.trim();
    }

    // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (!modal) {
        logError(`–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ${modalId} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
        showStatus('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
        return;
      }
      
      modal.classList.add('show');
      const input = modal.querySelector('input[type="text"], input[type="password"]');
      if (input) {
        setTimeout(() => input.focus(), 300);
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞–º–∏
    function showManageDialog() {
      showModal('manageModal');
    }

    function createNewSheet() {
      const name = document.getElementById('newSheetName').value.trim();
      
      if (!name) {
        showStatus('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error');
        return;
      }
      
      if (allSheets[name]) {
        showStatus('–õ–∏—Å—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      if (currentSheet) {
        allSheets[currentSheet] = [...tasksData];
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
      allSheets[name] = [];
      currentSheet = name;
      tasksData = [];
      
      updateSheetSelector();
      renderTasks();
      closeModal('createModal');
      saveToStorage();
      showStatus(`‚úÖ –õ–∏—Å—Ç "${name}" —Å–æ–∑–¥–∞–Ω`, 'success');
    }

    function showRenameDialog() {
      if (!currentSheet) return;
      
      const input = document.getElementById('renameInput');
      input.value = currentSheet;
      showModal('renameModal');
    }

    function confirmRename() {
      const newName = document.getElementById('renameInput').value.trim();
      
      if (!newName || newName === currentSheet) {
        closeModal('renameModal');
        return;
      }
      
      if (allSheets[newName]) {
        showStatus('–õ–∏—Å—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
        return;
      }
      
      // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ª–∏—Å—Ç
      allSheets[newName] = allSheets[currentSheet];
      delete allSheets[currentSheet];
      currentSheet = newName;
      
      updateSheetSelector();
      closeModal('renameModal');
      saveToStorage();
      showStatus(`‚úÖ –õ–∏—Å—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤ "${newName}"`, 'success');
    }

    function showDeleteDialog() {
      if (!currentSheet) return;
      
      document.getElementById('deleteText').textContent = `–£–¥–∞–ª–∏—Ç—å –ª–∏—Å—Ç "${currentSheet}"?`;
      showModal('deleteModal');
    }

    function confirmDelete() {
      if (Object.keys(allSheets).length === 1) {
        showStatus('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏—Å—Ç', 'error');
        closeModal('deleteModal');
        return;
      }
      
      delete allSheets[currentSheet];
      
      const sheets = Object.keys(allSheets).sort().reverse();
      currentSheet = sheets[0] || '';
      tasksData = currentSheet ? [...allSheets[currentSheet]] : [];
      
      updateSheetSelector();
      renderTasks();
      closeModal('deleteModal');
      saveToStorage();
      showStatus('‚úÖ –õ–∏—Å—Ç —É–¥–∞–ª–µ–Ω', 'success');
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    function showStatus(message, type = '') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.classList.add('show');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        status.classList.remove('show');
      }, 3000);
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>