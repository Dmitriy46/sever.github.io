<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Диспетчер грузоперевозок</title>
  <style>
    /* Основные стили для мобильных устройств */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-size: 18px;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .date-selector {
      margin-top: 10px;
    }
    
    .date-selector select {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.9);
      color: #333;
    }
    
    /* Главные кнопки действий */
    .main-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .big-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
      border: none;
      border-radius: 12px;
      background: #f8f9fa;
      color: #333;
      font-size: 14px;
      min-height: 80px;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
    }
    
    .big-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .big-button:active {
      transform: scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .big-button .icon {
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .big-button.primary {
      background: #667eea;
      color: white;
    }
    
    .big-button.success {
      background: #48bb78;
      color: white;
    }
    
    .big-button.danger {
      background: #f56565;
      color: white;
    }
    
    .big-button.warning {
      background: #f39c12;
      color: white;
    }
    
    /* Таблица заданий */
    .tasks-container {
      padding: 15px;
      min-height: 200px;
    }
    
    .task-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      transition: all 0.2s;
    }
    
    .task-card.selected {
      background: #e6f4ff;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
    }

    .task-card.editing {
      background: #f8fff8;
      box-shadow: 0 4px 15px rgba(72, 187, 120, 0.15);
      border-left: 4px solid #48bb78;
    }
    
    .task-card .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .task-card .machine-name {
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      min-height: 40px;
      background: white;
      transition: all 0.2s;
      outline: none;
    }
    
    .task-card .machine-name:empty:before {
      content: "Нажмите для ввода машин(ы)";
      color: #ff6666;
      font-style: italic;
      font-weight: normal;
      font-size: 18px;
    }
    
    .task-card .machine-name:focus {
      border-color: #667eea;
      background: white;
    }
    
    .task-card .select-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .task-detail {
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      margin-bottom: 8px;
      align-items: start;
    }
    
    .task-detail .label {
      font-size: 16px;
      color: #666;
      min-width: 110px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .task-detail .value {
      font-size: 16px;
      color: #333;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: all 0.2s;
      outline: none;
    }
    
    .task-detail .value:focus {
      border-color: #667eea;
      background: white;
    }
    
    .task-detail .value:empty:before {
      content: attr(placeholder);
      color: #999;
      font-style: italic;
    }
    
    /* Подзаказы */
    .task-card .sub-orders {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    .sub-order {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      position: relative;
    }
    
    .sub-order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .remove-sub-order {
      width: 24px;
      height: 24px;
      border: none;
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
    }
    
    .add-sub-order-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 2px dashed #667eea;
      background: transparent;
      color: #667eea;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .add-sub-order-btn:active {
      background: #667eea;
      color: white;
    }
    
    /* Дополнительные действия */
    .more-actions {
      padding: 0 15px 15px 15px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .secondary-button {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      font-size: 16px;
      color: #666;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .secondary-button:hover {
      background: #f8f9fa;
      transform: translateY(-1px);
    }
    
    .secondary-button:active {
      background: #f0f0f0;
      transform: translateY(0);
    }
    
    /* Статус сообщения */
    .status {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 25px;
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-size: 16px;
      z-index: 1001;
      display: none;
      max-width: 90%;
      text-align: center;
    }

    .status.show {
      display: block;
      animation: statusFade 3s ease-in-out forwards;
    }

    @keyframes statusFade {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      15% { opacity: 1; transform: translateX(-50%) translateY(0); }
      85% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    .status.success {
      background: #48bb78;
      color: white;
    }
    
    .status.error {
      background: #f56565;
      color: white;
    }
    
    /* Модальные окна */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.show {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: modalSlide 0.3s ease-out;
    }

    @keyframes modalSlide {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      font-size: 22px;
      color: #333;
    }
    
    .modal input {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 15px;
      outline: none;
      box-sizing: border-box;
    }
    
    .modal input:focus {
      border-color: #667eea;
    }

    .modal code {
      background: #f1f3f4;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-button {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .modal-button:hover {
      transform: translateY(-1px);
    }
    
    .modal-button.cancel {
      background: #f0f0f0;
      color: #666;
    }
    
    .modal-button.confirm {
      background: #667eea;
      color: white;
    }
    
    .modal-button.danger {
      background: #f56565;
      color: white;
    }
    
    /* Анимация shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.5s ease-in-out;
    }

    /* Стили для клавиш */
    kbd {
      background: #f4f4f4;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 0 0 2px #fff inset;
      color: #333;
      display: inline-block;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      margin: 0 2px;
      padding: 2px 6px;
      text-shadow: 0 1px 0 #fff;
    }
    
    /* Плавные переходы для полей */
    .task-detail .value,
    .task-card .machine-name {
      transition: all 0.2s ease;
    }

    /* Анимация при переходе фокуса */
    @keyframes focusGlow {
      0% {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.3);
        transform: scale(1.05);
      }
      100% {
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: scale(1.02);
      }
    }
    
    /* Пустое состояние */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    @media (min-width: 768px) {
      .main-actions {
        grid-template-columns: repeat(4, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .more-actions {
        grid-template-columns: repeat(4, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .tasks-container {
        max-width: 800px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>📋 Диспетчер грузоперевозок</h1>
    <div class="date-selector">
      <select id="sheetSelector" onchange="loadSheet()">
        <option value="">Загрузка...</option>
      </select>
    </div>
  </div>
  
  <div class="main-actions">
    <button onclick="addNewTask()" class="big-button warning">
      <span class="icon">➕</span>
      <span class="text">Новый заказ</span>
    </button>
    <button onclick="saveData()" class="big-button success">
      <span class="icon">💾</span>
      <span class="text">Сохранить</span>
    </button>
    <button onclick="sendToTelegram()" class="big-button primary">
      <span class="icon">📤</span>
      <span class="text">Telegram</span>
    </button>
    <button onclick="copyToClipboard()" class="big-button">
      <span class="icon">📋</span>
      <span class="text">Копировать</span>
    </button>
    <button onclick="showTelegramSettings()" class="big-button">
      <span class="icon">⚙️</span>
      <span class="text">Настройки</span>
    </button>
  </div>
  
  <div class="tasks-container" id="tasksContainer">
    <div class="empty-state">
      <div class="icon">📋</div>
      <div>Загрузка данных...</div>
    </div>
  </div>

  <!-- Подсказка по навигации -->
  <div id="navigationTip" style="text-align: center; padding: 10px; background: #f8f9fa; margin: 0 15px; border-radius: 8px; font-size: 14px; color: #666; border-left: 4px solid #667eea; display: none;">
    💡 <strong>Совет:</strong> Используйте <kbd>Enter</kbd> или <kbd>Tab</kbd> для быстрого перехода между полями
  </div>
  
  <div class="more-actions">
    <button onclick="duplicateSelected()" class="secondary-button">📑 Дублировать</button>
    <button onclick="deleteSelected()" class="secondary-button">🗑️ Удалить выбранные</button>
    <button onclick="showManageDialog()" class="secondary-button">⚙️ Управление</button>
    <button onclick="clearAllData()" class="secondary-button">🗑️ Очистить всё</button>
  </div>

  <!-- Статус -->
  <div id="status" class="status"></div>
  
  <!-- Модальные окна -->
  <div id="createModal" class="modal">
    <div class="modal-content">
      <h3>📅 Новая дата</h3>
      <input type="text" id="newSheetName" placeholder="Например: 12.06.2025">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('createModal')">Отмена</button>
        <button class="modal-button confirm" onclick="createNewSheet()">Создать</button>
      </div>
    </div>
  </div>
  
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <h3>✏️ Переименовать</h3>
      <input type="text" id="renameInput" placeholder="Новое название">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('renameModal')">Отмена</button>
        <button class="modal-button confirm" onclick="confirmRename()">Переименовать</button>
      </div>
    </div>
  </div>
  
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>🗑️ Удалить лист?</h3>
      <p id="deleteText" style="margin: 20px 0; text-align: center; color: #666;"></p>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('deleteModal')">Отмена</button>
        <button class="modal-button danger" onclick="confirmDelete()">Удалить</button>
      </div>
    </div>
  </div>
  
  <div id="manageModal" class="modal">
    <div class="modal-content">
      <h3>⚙️ Управление листами</h3>
      <button class="modal-button" onclick="closeModal('manageModal'); showRenameDialog();" style="width: 100%; margin-bottom: 10px; background: #667eea; color: white;">✏️ Переименовать лист</button>
      <button class="modal-button danger" onclick="closeModal('manageModal'); showDeleteDialog();" style="width: 100%; margin-bottom: 10px;">🗑️ Удалить лист</button>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-button cancel" onclick="closeModal('manageModal')">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Модальное окно настроек Telegram -->
  <div id="telegramSettingsModal" class="modal">
    <div class="modal-content">
      <h3>🤖 Настройки Telegram</h3>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Токен бота:</label>
        <input type="text" id="botTokenInput" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz" style="font-family: monospace; font-size: 14px;">
      </div>
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Chat ID:</label>
        <input type="text" id="chatIdInput" placeholder="-1234567890 или 1234567890" style="font-family: monospace; font-size: 14px;">
      </div>
      <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #666;">
        <strong>📋 Как получить данные:</strong><br>
        1. Напишите @BotFather в Telegram<br>
        2. Отправьте <code>/newbot</code><br>
        3. Следуйте инструкциям и получите <strong>токен</strong><br>
        4. Добавьте бота в группу/напишите ему<br>
        5. Отправьте любое сообщение<br>
        6. Откройте: <code>api.telegram.org/bot{ТОКЕН}/getUpdates</code><br>
        7. Скопируйте <strong>chat_id</strong> из ответа
      </div>
      <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; font-size: 13px; color: #856404;">
        🔒 <strong>Безопасность:</strong> Данные сохраняются только в вашем браузере и не передаются никому.
      </div>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('telegramSettingsModal')">Отмена</button>
        <button class="modal-button confirm" onclick="saveTelegramSettings()">Сохранить</button>
      </div>
    </div>
  </div>

  <script>
    // Глобальные переменные
    let currentSheet = '';
    let selectedTasks = new Set();
    let tasksData = [];
    let allSheets = {};

    // Константы
    const STORAGE_KEY = 'cargoDispatcher';
    const TELEGRAM_SETTINGS_KEY = 'cargoDispatcherTelegram';
    const VERSION = '1.0';

    // Настройки Telegram (будут загружены из localStorage)
    let telegramSettings = {
      botToken: '',
      chatId: ''
    };

    // Шаблоны для быстрого заполнения
    const templates = {
      machines: ['107', '486', '513', '444', '284', '295', '689', '986', '795', 'лагуна'],
      cargo: ['песок', 'щебень 31/63 м800', 'пгс', 'асфальт', 'почасовая'],
      routes: [
        'селычка - завьялово',
        'Сидоровы горы - ильф закирова',
        'сид горы - жк покровский',
        'селычка - жк магистральный',
        'сидоровы горы - Юськи',
        'абз агат - баграш бигра',
        'с поймы 34 на Можгу'
      ],
      customers: [
        'ООО Союзпромсирой',
        'ООО Римар', 
        'ООО ИЖГОРОДСТРОЙ',
        'ООО Инком',
        'ООО Дорстрой 44',
        'ООО ДМС'
      ]
    };

    // Утилиты
    function logError(message, error) {
      console.error(`[Cargo Dispatcher] ${message}:`, error);
    }

    function logInfo(message) {
      console.log(`[Cargo Dispatcher] ${message}`);
    }

    // Функции localStorage
    function saveToStorage() {
      try {
        const data = {
          version: VERSION,
          sheets: allSheets,
          lastSaved: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        logInfo('Данные сохранены в localStorage');
        return true;
      } catch (error) {
        logError('Ошибка сохранения', error);
        showStatus('Ошибка сохранения данных', 'error');
        return false;
      }
    }

    function loadFromStorage() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.sheets) {
            allSheets = data.sheets;
            logInfo('Данные загружены из localStorage');
            return true;
          }
        }
        return false;
      } catch (error) {
        logError('Ошибка загрузки', error);
        return false;
      }
    }

    // Функции для настроек Telegram
    function loadTelegramSettings() {
      try {
        const saved = localStorage.getItem(TELEGRAM_SETTINGS_KEY);
        if (saved) {
          telegramSettings = JSON.parse(saved);
          logInfo('Настройки Telegram загружены');
          return true;
        }
        return false;
      } catch (error) {
        logError('Ошибка загрузки настроек Telegram', error);
        return false;
      }
    }

    function saveTelegramSettingsToStorage() {
      try {
        localStorage.setItem(TELEGRAM_SETTINGS_KEY, JSON.stringify(telegramSettings));
        logInfo('Настройки Telegram сохранены');
        return true;
      } catch (error) {
        logError('Ошибка сохранения настроек Telegram', error);
        return false;
      }
    }

    function createInitialData() {
      const today = new Date().toLocaleDateString('ru-RU');
      allSheets = {
        [today]: [
          {
            machines: '107',
            orders: [{
              cargo: 'песок',
              from: 'селычка',
              to: 'завьялово', 
              customer: 'ООО Союзпромсирой',
              note: 'пример заказа'
            }]
          }
        ]
      };
      currentSheet = today;
      tasksData = [...allSheets[currentSheet]];
      logInfo('Созданы начальные данные');
    }

    // Инициализация
    function init() {
      logInfo('Инициализация приложения...');
      
      // Загружаем данные
      if (!loadFromStorage()) {
        createInitialData();
        saveToStorage();
      } else {
        // Выбираем последний лист
        const sheets = Object.keys(allSheets).sort().reverse();
        if (sheets.length > 0) {
          currentSheet = sheets[0];
          tasksData = [...allSheets[currentSheet]];
        } else {
          createInitialData();
        }
      }

      // Загружаем настройки Telegram
      loadTelegramSettings();

      updateSheetSelector();
      renderTasks();
      setupEventListeners();
      
      // Автосохранение каждые 30 секунд
      setInterval(() => {
        if (currentSheet && allSheets[currentSheet]) {
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
        }
      }, 30000);

      logInfo('Приложение инициализировано');
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
      // Закрытие модалок по клику вне
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });

      // Сохранение при закрытии страницы
      window.addEventListener('beforeunload', () => {
        if (currentSheet) {
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
        }
      });

      // Обработка клавиш
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 's':
              e.preventDefault();
              saveData();
              break;
            case 'n':
              e.preventDefault();
              addNewTask();
              break;
          }
        }
      });
    }

    // Обновление селектора листов
    function updateSheetSelector() {
      const selector = document.getElementById('sheetSelector');
      const sheets = Object.keys(allSheets).sort().reverse();
      
      selector.innerHTML = '<option value="_new">➕ Создать новую дату</option>' +
        sheets.map(sheet => 
          `<option value="${sheet}" ${sheet === currentSheet ? 'selected' : ''}>${sheet}</option>`
        ).join('');
    }

    // Загрузка данных листа
    function loadSheet() {
      const sheetName = document.getElementById('sheetSelector').value;
      
      if (sheetName === '_new') {
        document.getElementById('sheetSelector').value = currentSheet;
        showModal('createModal');
        return;
      }
      
      if (!sheetName || !allSheets[sheetName]) return;
      
      // Сохраняем текущие данные
      if (currentSheet && allSheets[currentSheet]) {
        allSheets[currentSheet] = [...tasksData];
      }
      
      currentSheet = sheetName;
      tasksData = [...allSheets[currentSheet]];
      renderTasks();
      saveToStorage();
      showStatus(`Загружен лист: ${sheetName}`, 'success');
    }

    // Отрисовка заданий
    function renderTasks() {
      const container = document.getElementById('tasksContainer');
      const helpTip = document.getElementById('navigationTip');
      container.innerHTML = '';
      selectedTasks.clear();
      
      if (tasksData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="icon">📋</div>
            <div>Нет заданий. Добавьте новый заказ!</div>
          </div>
        `;
        if (helpTip) helpTip.style.display = 'none';
        return;
      }
      
      tasksData.forEach((task, index) => {
        // Показываем даже пустые карточки для редактирования
        const taskCard = createTaskCard(task, index);
        container.appendChild(taskCard);
      });
      
      // Показываем подсказку о навигации
      if (helpTip) helpTip.style.display = 'block';
    }

    // Создание карточки задания
    function createTaskCard(taskData, index) {
      const card = document.createElement('div');
      card.className = 'task-card';
      card.dataset.index = index;
      
      let html = `
        <div class="machine-header">
          <div style="flex: 1; display: flex; align-items: center;">
            <span style="color: red; font-size: 24px; margin-right: 5px;">*</span>
            <div class="machine-name" contenteditable="true" data-field="machines">${taskData.machines ? '🚛 ' + taskData.machines : ''}</div>
          </div>
          <input type="checkbox" class="select-checkbox" onchange="toggleSelection(${index})">
        </div>
        <div class="sub-orders">
      `;
      
      taskData.orders.forEach((order, orderIndex) => {
        html += `
          <div class="sub-order" data-order-index="${orderIndex}">
            <div class="sub-order-header">
              <span>Заказ ${orderIndex + 1}</span>
              ${taskData.orders.length > 1 ? 
                `<button class="remove-sub-order" onclick="removeSubOrder(${index}, ${orderIndex})">×</button>` : ''}
            </div>
            <div class="task-detail">
              <span class="label">📦 Груз:</span>
              <div class="value" contenteditable="true" data-field="cargo" data-order="${orderIndex}" placeholder="Введите груз">${order.cargo || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📍 Откуда:</span>
              <div class="value" contenteditable="true" data-field="from" data-order="${orderIndex}" placeholder="Место загрузки">${order.from || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📍 Куда:</span>
              <div class="value" contenteditable="true" data-field="to" data-order="${orderIndex}" placeholder="Место выгрузки">${order.to || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">👤 Заказчик:</span>
              <div class="value" contenteditable="true" data-field="customer" data-order="${orderIndex}" placeholder="Название компании">${order.customer || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📝 Заметка:</span>
              <div class="value" contenteditable="true" data-field="note" data-order="${orderIndex}" placeholder="Дополнительная информация">${order.note || ''}</div>
            </div>
          </div>
        `;
      });
      
      html += `
          <button class="add-sub-order-btn" onclick="addSubOrder(${index})">+ Добавить заказ для этих машин</button>
        </div>
      `;
      
      card.innerHTML = html;
      
      // Обработчики изменений
      card.querySelectorAll('[contenteditable]').forEach(elem => {
        elem.addEventListener('input', () => updateTaskData(index, elem));
        elem.addEventListener('blur', () => {
          // Автосохранение при потере фокуса
          allSheets[currentSheet] = [...tasksData];
          saveToStorage();
          
          // Убираем подсветку карточки
          card.classList.remove('editing');
        });
        
        elem.addEventListener('focus', () => {
          // Подсвечиваем карточку при фокусе
          card.classList.add('editing');
        });
        
        // Навигация по полям
        elem.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            moveToNextField(elem);
          } else if (e.key === 'Tab') {
            // Tab тоже работает для перехода
            e.preventDefault();
            if (e.shiftKey) {
              moveToPrevField(elem);
            } else {
              moveToNextField(elem);
            }
          }
        });
      });
      
      return card;
    }

    // Обновление данных задания
    function updateTaskData(index, element) {
      if (!tasksData[index]) return;
      
      const field = element.dataset.field;
      const orderIndex = element.dataset.order;
      const value = element.textContent.trim();
      
      if (field === 'machines') {
        tasksData[index].machines = value;
      } else if (orderIndex !== undefined && tasksData[index].orders[orderIndex]) {
        tasksData[index].orders[orderIndex][field] = value;
      }
    }

    // Навигация между полями
    function moveToNextField(currentElement) {
      const field = currentElement.dataset.field;
      const orderIndex = currentElement.dataset.order;
      const taskCard = currentElement.closest('.task-card');
      const taskIndex = parseInt(taskCard.dataset.index);
      
      let nextElement = null;
      
      // Определяем следующее поле
      if (field === 'machines') {
        // От машин к первому грузу
        nextElement = taskCard.querySelector('[data-field="cargo"][data-order="0"]');
      } else if (field === 'cargo') {
        // От груза к откуда
        nextElement = taskCard.querySelector(`[data-field="from"][data-order="${orderIndex}"]`);
      } else if (field === 'from') {
        // От откуда к куда
        nextElement = taskCard.querySelector(`[data-field="to"][data-order="${orderIndex}"]`);
      } else if (field === 'to') {
        // От куда к заказчику
        nextElement = taskCard.querySelector(`[data-field="customer"][data-order="${orderIndex}"]`);
      } else if (field === 'customer') {
        // От заказчика к заметке
        nextElement = taskCard.querySelector(`[data-field="note"][data-order="${orderIndex}"]`);
      } else if (field === 'note') {
        // От заметки к следующему заказу или новой карточке
        const nextOrderIndex = parseInt(orderIndex) + 1;
        nextElement = taskCard.querySelector(`[data-field="cargo"][data-order="${nextOrderIndex}"]`);
        
        if (!nextElement) {
          // Можем создать новый заказ в той же карточке если есть машины
          const machinesField = taskCard.querySelector('[data-field="machines"]');
          if (machinesField && machinesField.textContent.trim()) {
            // Создаем новый заказ в текущей карточке
            addSubOrder(taskIndex);
            setTimeout(() => {
              const newOrder = taskCard.querySelector(`[data-field="cargo"][data-order="${nextOrderIndex}"]`);
              if (newOrder) {
                newOrder.focus();
                showStatus('➕ Добавлен новый заказ', 'success');
              }
            }, 100);
            return;
          } else {
            // Переходим к следующей карточке или создаем новую
            const nextTaskCard = document.querySelector(`.task-card[data-index="${taskIndex + 1}"]`);
            if (nextTaskCard) {
              nextElement = nextTaskCard.querySelector('[data-field="machines"]');
            } else {
              // Создаем новую карточку
              addNewTask();
              setTimeout(() => {
                const newCard = document.querySelector(`.task-card[data-index="${tasksData.length - 1}"]`);
                if (newCard) {
                  nextElement = newCard.querySelector('[data-field="machines"]');
                  if (nextElement) nextElement.focus();
                }
              }, 100);
              return;
            }
          }
        }
      }
      
      if (nextElement) {
        nextElement.focus();
        
        // Плавная анимация перехода
        nextElement.style.animation = 'focusGlow 0.5s ease-out';
        setTimeout(() => {
          nextElement.style.animation = '';
        }, 500);
        
        // Устанавливаем курсор в конец текста
        if (nextElement.textContent) {
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(nextElement);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }
    
    function moveToPrevField(currentElement) {
      const field = currentElement.dataset.field;
      const orderIndex = currentElement.dataset.order;
      const taskCard = currentElement.closest('.task-card');
      const taskIndex = parseInt(taskCard.dataset.index);
      
      let prevElement = null;
      
      // Определяем предыдущее поле
      if (field === 'cargo' && orderIndex === '0') {
        // От первого груза к машинам
        prevElement = taskCard.querySelector('[data-field="machines"]');
      } else if (field === 'cargo') {
        // От груза к заметке предыдущего заказа
        const prevOrderIndex = parseInt(orderIndex) - 1;
        prevElement = taskCard.querySelector(`[data-field="note"][data-order="${prevOrderIndex}"]`);
      } else if (field === 'from') {
        // От откуда к грузу
        prevElement = taskCard.querySelector(`[data-field="cargo"][data-order="${orderIndex}"]`);
      } else if (field === 'to') {
        // От куда к откуда
        prevElement = taskCard.querySelector(`[data-field="from"][data-order="${orderIndex}"]`);
      } else if (field === 'customer') {
        // От заказчика к куда
        prevElement = taskCard.querySelector(`[data-field="to"][data-order="${orderIndex}"]`);
      } else if (field === 'note') {
        // От заметки к заказчику
        prevElement = taskCard.querySelector(`[data-field="customer"][data-order="${orderIndex}"]`);
      } else if (field === 'machines') {
        // От машин к предыдущей карточке
        const prevTaskCard = document.querySelector(`.task-card[data-index="${taskIndex - 1}"]`);
        if (prevTaskCard) {
          // Находим последнее поле в предыдущей карточке
          const lastSubOrder = prevTaskCard.querySelector('.sub-order:last-child');
          if (lastSubOrder) {
            prevElement = lastSubOrder.querySelector('[data-field="note"]');
          }
        }
      }
      
      if (prevElement) {
        prevElement.focus();
        
        // Плавная анимация перехода
        prevElement.style.animation = 'focusGlow 0.5s ease-out';
        setTimeout(() => {
          prevElement.style.animation = '';
        }, 500);
        
        // Устанавливаем курсор в конец текста
        if (prevElement.textContent) {
          const range = document.createRange();
          const sel = window.getSelection();
          range.selectNodeContents(prevElement);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }
      }
    }

    // Добавить подзаказ
    function addSubOrder(taskIndex) {
      if (!tasksData[taskIndex]) return;
      
      tasksData[taskIndex].orders.push({
        cargo: '',
        from: '',
        to: '',
        customer: '',
        note: ''
      });
      
      renderTasks();
      
      setTimeout(() => {
        const card = document.querySelector(`.task-card[data-index="${taskIndex}"]`);
        if (card) {
          const newOrder = card.querySelector('.sub-order:last-child');
          if (newOrder) {
            newOrder.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const firstInput = newOrder.querySelector('[data-field="cargo"]');
            if (firstInput) firstInput.focus();
          }
        }
      }, 100);
    }

    // Удалить подзаказ
    function removeSubOrder(taskIndex, orderIndex) {
      if (!tasksData[taskIndex] || tasksData[taskIndex].orders.length <= 1) return;
      
      tasksData[taskIndex].orders.splice(orderIndex, 1);
      renderTasks();
      showStatus('Заказ удален', 'success');
      
      // Сохраняем изменения
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // Переключение выделения
    function toggleSelection(index) {
      const card = document.querySelector(`.task-card[data-index="${index}"]`);
      if (!card) return;
      
      if (selectedTasks.has(index)) {
        selectedTasks.delete(index);
        card.classList.remove('selected');
      } else {
        selectedTasks.add(index);
        card.classList.add('selected');
      }
    }

    // Добавление нового задания
    function addNewTask() {
      const newTask = {
        machines: '',
        orders: [{
          cargo: '',
          from: '',
          to: '',
          customer: '',
          note: ''
        }]
      };
      
      tasksData.push(newTask);
      renderTasks();
      
      setTimeout(() => {
        const newCard = document.querySelector(`.task-card[data-index="${tasksData.length - 1}"]`);
        if (newCard) {
          const machineInput = newCard.querySelector('[data-field="machines"]');
          if (machineInput) {
            machineInput.focus();
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }, 100);
      
      showStatus('Добавлен новый заказ', 'success');
    }

    // Дублировать выбранные задания
    function duplicateSelected() {
      if (selectedTasks.size === 0) {
        showStatus('Выберите задания для дублирования', 'error');
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        if (tasksData[index]) {
          const original = tasksData[index];
          const duplicate = {
            machines: '',
            orders: original.orders.map(order => ({...order}))
          };
          tasksData.splice(index + 1, 0, duplicate);
        }
      });
      
      renderTasks();
      showStatus(`Продублировано заданий: ${indices.length}`, 'success');
      
      // Сохраняем изменения
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // Удалить выбранные задания
    function deleteSelected() {
      if (selectedTasks.size === 0) {
        showStatus('Выберите задания для удаления', 'error');
        return;
      }
      
      if (!confirm(`Удалить выбранные задания (${selectedTasks.size} шт.)?`)) {
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        if (tasksData[index]) {
          tasksData.splice(index, 1);
        }
      });
      
      renderTasks();
      showStatus('Задания удалены', 'success');
      
      // Сохраняем изменения
      allSheets[currentSheet] = [...tasksData];
      saveToStorage();
    }

    // Сохранение данных
    function saveData() {
      // Проверка на пустые машины
      const emptyMachines = tasksData.filter(t => 
        !t.machines && t.orders.some(o => o.cargo || o.from || o.to || o.customer)
      );
      
      if (emptyMachines.length > 0) {
        showStatus('❌ Заполните номера машин во всех заказах!', 'error');
        
        // Подсветить пустые поля
        document.querySelectorAll('.machine-name').forEach(el => {
          if (!el.textContent.trim()) {
            el.classList.add('shake');
            setTimeout(() => el.classList.remove('shake'), 500);
          }
        });
        return;
      }
      
      // Сохраняем данные
      allSheets[currentSheet] = [...tasksData];
      
      if (saveToStorage()) {
        showStatus('✅ Данные сохранены!', 'success');
      }
    }

    // Отправка в Telegram
    async function sendToTelegram() {
      // Проверяем наличие настроек
      if (!telegramSettings.botToken || !telegramSettings.chatId) {
        showStatus('Настройте Telegram бота в настройках', 'error');
        setTimeout(() => showTelegramSettings(), 1000);
        return;
      }

      const message = formatForTelegram();
      
      if (!message.trim()) {
        showStatus('Нет данных для отправки', 'error');
        return;
      }
      
      showStatus('Отправка в Telegram...');
      
      try {
        const response = await fetch(`https://api.telegram.org/bot${telegramSettings.botToken}/sendMessage`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            chat_id: telegramSettings.chatId,
            text: message,
            parse_mode: 'HTML',
            disable_web_page_preview: true
          })
        });
        
        const result = await response.json();
        
        if (!result.ok) {
          throw new Error(result.description || 'Ошибка отправки');
        }
        
        showStatus('✅ Отправлено в Telegram!', 'success');
        
      } catch (error) {
        logError('Ошибка отправки в Telegram', error);
        
        if (error.message.includes('chat not found') || error.message.includes('Forbidden')) {
          showStatus('Ошибка: Бот не добавлен в чат или заблокирован', 'error');
        } else if (error.message.includes('token') || error.message.includes('Unauthorized')) {
          showStatus('Ошибка: Неверный токен бота', 'error');
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
          showStatus('Ошибка сети. Проверьте интернет', 'error');
        } else {
          showStatus('Ошибка отправки: ' + error.message, 'error');
        }
      }
    }

    // Показать настройки Telegram
    function showTelegramSettings() {
      // Заполняем текущие значения
      document.getElementById('botTokenInput').value = telegramSettings.botToken || '';
      document.getElementById('chatIdInput').value = telegramSettings.chatId || '';
      
      showModal('telegramSettingsModal');
    }

    // Сохранить настройки Telegram
    function saveTelegramSettings() {
      const botToken = document.getElementById('botTokenInput').value.trim();
      const chatId = document.getElementById('chatIdInput').value.trim();
      
      if (!botToken || !chatId) {
        showStatus('Заполните все поля', 'error');
        return;
      }
      
      // Простая валидация токена
      if (!botToken.includes(':') || botToken.length < 20) {
        showStatus('Неверный формат токена бота', 'error');
        return;
      }
      
      // Простая валидация chat ID
      if (!/^-?\d+$/.test(chatId)) {
        showStatus('Chat ID должен быть числом', 'error');
        return;
      }
      
      telegramSettings.botToken = botToken;
      telegramSettings.chatId = chatId;
      
      if (saveTelegramSettingsToStorage()) {
        closeModal('telegramSettingsModal');
        showStatus('✅ Настройки Telegram сохранены', 'success');
      } else {
        showStatus('Ошибка сохранения настроек', 'error');
      }
    }

    // Форматирование для Telegram (с HTML разметкой)
    function formatForTelegram() {
      const activeTasks = tasksData.filter(task => task.machines);
      
      if (activeTasks.length === 0) {
        return `📅 <b>${currentSheet}</b>\n\nНет заданий на эту дату.`;
      }
      
      let message = `📅 <b>${currentSheet}</b>\n\n`;
      
      activeTasks.forEach((task, taskIndex) => {
        message += `🚛 <b>${task.machines}</b>\n`;
        
        task.orders.forEach((order, orderIndex) => {
          if (task.orders.length > 1) {
            message += `  ${orderIndex + 1}. `;
          } else {
            message += `  `;
          }
          
          message += `📦 ${order.cargo || '-'} | `;
          message += `📍 ${order.from || '?'} → ${order.to || '?'} | `;
          message += `👤 ${order.customer || '-'}`;
          
          if (order.note) {
            message += `\n     📝 <i>${order.note}</i>`;
          }
          message += '\n';
        });
        
        message += '\n';
      });
      
      // Ограничение длины сообщения Telegram (4096 символов)
      if (message.length > 4000) {
        message = message.substring(0, 3997) + "...";
      }
      
      return message.trim();
    }

    // Очистить все данные
    function clearAllData() {
      if (!confirm('Удалить ВСЕ данные? Это действие нельзя отменить!')) {
        return;
      }
      
      if (!confirm('Вы уверены? Все листы, задания и настройки Telegram будут удалены!')) {
        return;
      }
      
      try {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(TELEGRAM_SETTINGS_KEY);
        
        allSheets = {};
        tasksData = [];
        currentSheet = '';
        telegramSettings = { botToken: '', chatId: '' };
        
        // Создаем новый лист
        createInitialData();
        updateSheetSelector();
        renderTasks();
        saveToStorage();
        
        showStatus('✅ Все данные удалены', 'success');
      } catch (error) {
        logError('Ошибка очистки данных', error);
        showStatus('Ошибка очистки данных', 'error');
      }
    }

    // Копирование в буфер обмена
    function copyToClipboard() {
      const message = formatForClipboard();
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(message)
          .then(() => showStatus('✅ Скопировано!', 'success'))
          .catch(() => fallbackCopy(message));
      } else {
        fallbackCopy(message);
      }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      
      try {
        document.execCommand('copy');
        showStatus('✅ Скопировано!', 'success');
      } catch (error) {
        showStatus('Ошибка копирования', 'error');
      }
      
      document.body.removeChild(textarea);
    }

    // Форматирование для буфера обмена
    function formatForClipboard() {
      let message = `📅 ${currentSheet}\n\n`;
      
      const activeTasks = tasksData.filter(task => task.machines);
      
      if (activeTasks.length === 0) {
        message += 'Нет заданий на эту дату.\n';
        return message;
      }
      
      activeTasks.forEach((task, taskIndex) => {
        message += `🚛 ${task.machines}\n`;
        
        task.orders.forEach((order, orderIndex) => {
          if (task.orders.length > 1) {
            message += `  ${orderIndex + 1}. `;
          } else {
            message += `  `;
          }
          
          message += `📦 ${order.cargo || '-'} | `;
          message += `📍 ${order.from || '?'} → ${order.to || '?'} | `;
          message += `👤 ${order.customer || '-'}`;
          
          if (order.note) {
            message += `\n     📝 ${order.note}`;
          }
          message += '\n';
        });
        
        message += '\n';
      });
      
      return message.trim();
    }

    // Модальные окна
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
        const input = modal.querySelector('input');
        if (input) {
          input.value = '';
          setTimeout(() => input.focus(), 300);
        }
      }
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // Управление листами
    function showManageDialog() {
      showModal('manageModal');
    }

    function createNewSheet() {
      const name = document.getElementById('newSheetName').value.trim();
      
      if (!name) {
        showStatus('Введите название', 'error');
        return;
      }
      
      if (allSheets[name]) {
        showStatus('Лист с таким названием уже существует', 'error');
        return;
      }
      
      // Сохраняем текущие данные
      if (currentSheet) {
        allSheets[currentSheet] = [...tasksData];
      }
      
      // Создаем новый лист
      allSheets[name] = [];
      currentSheet = name;
      tasksData = [];
      
      updateSheetSelector();
      renderTasks();
      closeModal('createModal');
      saveToStorage();
      showStatus(`✅ Лист "${name}" создан`, 'success');
    }

    function showRenameDialog() {
      if (!currentSheet) return;
      
      const input = document.getElementById('renameInput');
      input.value = currentSheet;
      showModal('renameModal');
    }

    function confirmRename() {
      const newName = document.getElementById('renameInput').value.trim();
      
      if (!newName || newName === currentSheet) {
        closeModal('renameModal');
        return;
      }
      
      if (allSheets[newName]) {
        showStatus('Лист с таким названием уже существует', 'error');
        return;
      }
      
      // Переименовываем лист
      allSheets[newName] = allSheets[currentSheet];
      delete allSheets[currentSheet];
      currentSheet = newName;
      
      updateSheetSelector();
      closeModal('renameModal');
      saveToStorage();
      showStatus(`✅ Лист переименован в "${newName}"`, 'success');
    }

    function showDeleteDialog() {
      if (!currentSheet) return;
      
      document.getElementById('deleteText').textContent = `Удалить лист "${currentSheet}"?`;
      showModal('deleteModal');
    }

    function confirmDelete() {
      if (Object.keys(allSheets).length === 1) {
        showStatus('Нельзя удалить последний лист', 'error');
        closeModal('deleteModal');
        return;
      }
      
      delete allSheets[currentSheet];
      
      const sheets = Object.keys(allSheets).sort().reverse();
      currentSheet = sheets[0] || '';
      tasksData = currentSheet ? [...allSheets[currentSheet]] : [];
      
      updateSheetSelector();
      renderTasks();
      closeModal('deleteModal');
      saveToStorage();
      showStatus('✅ Лист удален', 'success');
    }

    // Показать статус
    function showStatus(message, type = '') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.classList.add('show');
      
      // Автоматически скрываем через 3 секунды
      setTimeout(() => {
        status.classList.remove('show');
      }, 3000);
    }

    // Запуск приложения
    document.addEventListener('DOMContentLoaded', init);

    // Отладочные функции (можно удалить в продакшене)
    window.debugApp = {
      getAllData: () => allSheets,
      getCurrentData: () => tasksData,
      clearAll: () => clearAllData(),
      testTelegram: () => sendToTelegram(),
      telegramConfigured: () => !!(telegramSettings.botToken && telegramSettings.chatId),
      testNavigation: () => {
        const firstField = document.querySelector('[contenteditable]');
        if (firstField) {
          firstField.focus();
          console.log('Используйте Enter или Tab для перехода между полями');
        }
      },
      exportDebug: () => {
        console.log('All sheets:', allSheets);
        console.log('Current sheet:', currentSheet);
        console.log('Current tasks:', tasksData);
        console.log('Telegram configured:', !!(telegramSettings.botToken && telegramSettings.chatId));
        console.log('Navigation: Enter/Tab для перехода, Shift+Tab для обратного перехода');
      }
    };
  </script>
</body>
</html>