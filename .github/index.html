<div id="status" class="status" style="display:none;"></div><!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    /* Основные стили для мобильных устройств */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      font-size: 18px;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .date-selector {
      margin-top: 10px;
    }
    
    .date-selector select {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.9);
      color: #333;
    }
    
    /* Главные кнопки действий */
    .main-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 15px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .big-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
      border: none;
      border-radius: 12px;
      background: #f8f9fa;
      color: #333;
      font-size: 14px;
      min-height: 80px;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .big-button:active {
      transform: scale(0.98);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .big-button .icon {
      font-size: 28px;
      margin-bottom: 5px;
    }
    
    .big-button.primary {
      background: #667eea;
      color: white;
    }
    
    .big-button.success {
      background: #48bb78;
      color: white;
    }
    
    .big-button.danger {
      background: #f56565;
      color: white;
    }
    
    /* Таблица заданий */
    .tasks-container {
      padding: 15px;
    }
    
    .task-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      position: relative;
      transition: all 0.2s;
    }
    
    .task-card.selected {
      background: #e6f4ff;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.2);
    }
    
    .task-card .machine-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .task-card .machine-name {
      font-size: 20px;
      font-weight: 600;
      color: #667eea;
    }
    
    .task-card .select-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .task-detail {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      margin-bottom: 8px;
      align-items: start;
    }
    
    .task-detail .label {
      font-size: 16px;
      color: #666;
      min-width: 80px;
    }
    
    .task-detail .value {
      font-size: 16px;
      color: #333;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    
    .task-detail .value:focus {
      outline: none;
      border-color: #667eea;
      background: white;
    }
    
    /* Быстрое меню выбора */
    .quick-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.15);
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
      -webkit-overflow-scrolling: touch;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .quick-menu h3 {
      margin: 0 0 15px 0;
      color: #333;
      text-align: center;
    }
    
    .quick-menu-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      border: none;
      background: #f0f0f0;
      border-radius: 50%;
      font-size: 20px;
      color: #666;
    }
    
    .quick-option {
      display: block;
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      text-align: left;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .quick-option:active {
      background: #667eea;
      color: white;
      transform: scale(0.98);
    }
    
    /* Удаляем плавающую кнопку, так как добавили в основные действия */
    
    /* Дополнительные действия */
    .more-actions {
      padding: 0 15px 15px 15px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .secondary-button {
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      font-size: 16px;
      color: #666;
      transition: all 0.2s;
    }
    
    .secondary-button:active {
      background: #f8f9fa;
    }
    
    /* Статус сообщения */
    .status {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      border-radius: 25px;
      background: white;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      font-size: 16px;
      z-index: 1001;
      animation: fadeInOut 3s ease-in-out;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      20% { opacity: 1; transform: translateX(-50%) translateY(0); }
      80% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    }
    
    .status.success {
      background: #48bb78;
      color: white;
    }
    
    .status.error {
      background: #f56565;
      color: white;
    }
    
    /* Модальные окна */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      font-size: 22px;
      color: #333;
    }
    
    .modal input {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .modal input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    
    .modal-button {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .modal-button.cancel {
      background: #f0f0f0;
      color: #666;
    }
    
    .modal-button.confirm {
      background: #667eea;
      color: white;
    }
    
    /* Группировка машин */
    .group-header {
      background: #f0f7ff;
      border-left: 4px solid #667eea;
      padding: 10px 15px;
      margin: 15px 0 10px 0;
      font-weight: 600;
      color: #667eea;
      border-radius: 0 8px 8px 0;
    }
    
    /* Шаблоны */
    .templates-section {
      padding: 15px;
      background: white;
      margin-bottom: 10px;
    }
    
    .template-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .chip {
      padding: 8px 16px;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 14px;
      border: none;
      transition: all 0.2s;
    }
    
    .chip:active {
      background: #667eea;
      color: white;
    }
    
    /* Стили для подзаказов */
    .task-card .sub-orders {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e0e0e0;
    }
    
    .sub-order {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      position: relative;
    }
    
    .sub-order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
      color: #666;
    }
    
    .remove-sub-order {
      width: 24px;
      height: 24px;
      border: none;
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
    }
    
    .add-sub-order-btn {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border: 2px dashed #667eea;
      background: transparent;
      color: #667eea;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .add-sub-order-btn:active {
      background: #667eea;
      color: white;
    }
    [contenteditable]:empty:before {
      content: attr(placeholder);
      color: #999;
      font-style: italic;
    }
    
    .task-card .machine-name:empty:before {
      content: "Нажмите для ввода машин(ы)";
    }
    @media (min-width: 768px) {
      .main-actions {
        grid-template-columns: repeat(6, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .more-actions {
        grid-template-columns: repeat(4, 1fr);
        max-width: 800px;
        margin: 0 auto;
      }
      
      .tasks-container {
        max-width: 800px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>📋 Диспетчер грузоперевозок</h1>
    <div class="date-selector">
      <select id="sheetSelector" onchange="loadSheet()">
        <option value="">Загрузка дат...</option>
      </select>
    </div>
  </div>
  
  <div class="main-actions">
    <button onclick="addNewTask()" class="big-button" style="background: #f39c12;">
      <span class="icon">➕</span>
      <span class="text">Новый заказ</span>
    </button>
    <button onclick="saveData()" class="big-button success">
      <span class="icon">💾</span>
      <span class="text">Сохранить</span>
    </button>
    <button onclick="sendToTelegram()" class="big-button primary">
      <span class="icon">📤</span>
      <span class="text">Telegram</span>
    </button>
    <button onclick="copyToClipboard()" class="big-button">
      <span class="icon">📋</span>
      <span class="text">Копировать</span>
    </button>
  </div>
  
  <div class="tasks-container" id="tasksContainer">
    <!-- Здесь будут карточки заданий -->
  </div>
  
  <div class="more-actions">
    <button onclick="duplicateSelected()" class="secondary-button">📑 Дублировать</button>
    <button onclick="deleteSelected()" class="secondary-button">🗑️ Удалить выбранные</button>
    <button onclick="showManageDialog()" class="secondary-button">⚙️ Управление</button>
  </div>
  
  <!-- Модальное окно создания листа -->
  <div id="createModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>📅 Новая дата</h3>
      <input type="text" id="newSheetName" placeholder="Например: 07.06.2024">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('createModal')">Отмена</button>
        <button class="modal-button confirm" onclick="createNewSheet()">Создать</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно переименования -->
  <div id="renameModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>✏️ Переименовать</h3>
      <input type="text" id="renameInput" placeholder="Новое название">
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('renameModal')">Отмена</button>
        <button class="modal-button confirm" onclick="confirmRename()">Переименовать</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно удаления -->
  <div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>🗑️ Удалить лист?</h3>
      <p id="deleteText" style="margin: 20px 0; text-align: center; color: #666;"></p>
      <div class="modal-buttons">
        <button class="modal-button cancel" onclick="closeModal('deleteModal')">Отмена</button>
        <button class="modal-button confirm" style="background: #f56565;" onclick="confirmDelete()">Удалить</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно управления -->
  <div id="manageModal" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>⚙️ Управление листами</h3>
      <button class="modal-button" onclick="closeModal('manageModal'); showRenameDialog();" style="width: 100%; margin-bottom: 10px;">✏️ Переименовать лист</button>
      <button class="modal-button" onclick="closeModal('manageModal'); showDeleteDialog();" style="width: 100%; background: #f56565; color: white;">🗑️ Удалить лист</button>
      <div class="modal-buttons" style="margin-top: 20px;">
        <button class="modal-button cancel" onclick="closeModal('manageModal')">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    // Глобальные переменные
    let currentSheet = '';
    let selectedTasks = new Set();
    let tasksData = []; // Теперь будет содержать объекты с машинами и массивом заказов
    
    // Преобразование старого формата в новый
    function convertOldFormat(oldData) {
      // Группируем по машинам
      const groups = {};
      oldData.forEach(row => {
        if (!row[0]) return;
        const key = row[0]; // машины
        if (!groups[key]) {
          groups[key] = {
            machines: key,
            orders: []
          };
        }
        groups[key].orders.push({
          cargo: row[1] || '',
          from: row[2] || '',
          to: row[3] || '',
          customer: row[4] || '',
          note: row[5] || ''
        });
      });
      return Object.values(groups);
    }
    
    // Преобразование нового формата в старый для сохранения
    function convertToOldFormat(newData) {
      const oldFormat = [];
      newData.forEach(task => {
        task.orders.forEach(order => {
          oldFormat.push([
            task.machines,
            order.cargo,
            order.from,
            order.to,
            order.customer,
            order.note
          ]);
        });
      });
      return oldFormat;
    }
    
    // Шаблоны для быстрого заполнения
    const templates = {
      machines: ['107', '486', '513', '444', '284', '295', '689', '986', '795', 'лагуна'],
      cargo: ['песок', 'щебень 31/63 м800', 'пгс', 'асфальт', 'почасовая'],
      routes: [
        'селычка - завьялово',
        'Сидоровы горы - ильф закирова',
        'сид горы - жк покровский',
        'селычка - жк магистральный',
        'сидоровы горы - Юськи',
        'абз агат - баграш бигра',
        'с поймы 34 на Можгу'
      ],
      customers: [
        'ООО Союзпромсирой',
        'ООО Римар',
        'ООО ИЖГОРОДСТРОЙ',
        'ООО Инком',
        'ООО Дорстрой 44',
        'ООО ДМС'
      ]
    };
    
    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      loadSheets();
      setupEventListeners();
    });
    
    // Настройка обработчиков событий
    function setupEventListeners() {
      // Закрытие модалок по клику вне
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      });
    }
    
    // Загрузка списка листов
    function loadSheets() {
      google.script.run
        .withSuccessHandler(sheets => {
          const selector = document.getElementById('sheetSelector');
          selector.innerHTML = '<option value="_new">➕ Создать новую дату</option>' +
            sheets.map(sheet => `<option value="${sheet}">${sheet}</option>`).join('');
          
          if (sheets.length > 0) {
            currentSheet = sheets[0];
            selector.value = currentSheet;
            loadSheet();
          }
        })
        .withFailureHandler(showError)
        .getSheetNames();
    }
    
    // Загрузка данных листа
    function loadSheet() {
      const sheetName = document.getElementById('sheetSelector').value;
      
      if (sheetName === '_new') {
        document.getElementById('sheetSelector').value = currentSheet;
        showModal('createModal');
        return;
      }
      
      if (!sheetName) return;
      
      showStatus('Загрузка...');
      google.script.run
        .withSuccessHandler(result => {
          currentSheet = result.sheetName;
          // Преобразуем старый формат в новый
          tasksData = convertOldFormat(result.data);
          renderTasks();
          hideStatus();
        })
        .withFailureHandler(showError)
        .getSheetData(sheetName);
    }
    
    // Отрисовка заданий
    function renderTasks() {
      const container = document.getElementById('tasksContainer');
      container.innerHTML = '';
      selectedTasks.clear();
      
      tasksData.forEach((task, index) => {
        if (!task.machines && task.orders.every(o => !o.cargo && !o.from && !o.to && !o.customer)) return; // Пропускаем полностью пустые
        
        const taskCard = createTaskCard(task, index);
        container.appendChild(taskCard);
      });
    }
    
    // Создание карточки задания
    function createTaskCard(taskData, index) {
      const card = document.createElement('div');
      card.className = 'task-card';
      card.dataset.index = index;
      
      // Шапка с машинами
      let html = `
        <div class="machine-header">
          <div class="machine-name" contenteditable="true" data-field="machines">🚛 ${taskData.machines || 'Машина'}</div>
          <input type="checkbox" class="select-checkbox" onchange="toggleSelection(${index})">
        </div>
        <div class="sub-orders">
      `;
      
      // Заказы для этих машин
      taskData.orders.forEach((order, orderIndex) => {
        html += `
          <div class="sub-order" data-order-index="${orderIndex}">
            <div class="sub-order-header">
              <span>Заказ ${orderIndex + 1}</span>
              ${taskData.orders.length > 1 ? `<button class="remove-sub-order" onclick="removeSubOrder(${index}, ${orderIndex})">×</button>` : ''}
            </div>
            <div class="task-detail">
              <span class="label">📦 Груз:</span>
              <div class="value" contenteditable="true" data-field="cargo" data-order="${orderIndex}">${order.cargo || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📍 Откуда:</span>
              <div class="value" contenteditable="true" data-field="from" data-order="${orderIndex}">${order.from || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📍 Куда:</span>
              <div class="value" contenteditable="true" data-field="to" data-order="${orderIndex}">${order.to || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">👤 Заказчик:</span>
              <div class="value" contenteditable="true" data-field="customer" data-order="${orderIndex}">${order.customer || ''}</div>
            </div>
            <div class="task-detail">
              <span class="label">📝 Заметка:</span>
              <div class="value" contenteditable="true" data-field="note" data-order="${orderIndex}">${order.note || ''}</div>
            </div>
          </div>
        `;
      });
      
      html += `
          <button class="add-sub-order-btn" onclick="addSubOrder(${index})">+ Добавить заказ для этих машин</button>
        </div>
      `;
      
      card.innerHTML = html;
      
      // Обработчики изменений
      card.querySelectorAll('[contenteditable]').forEach(elem => {
        elem.addEventListener('input', () => updateTaskData(index, elem));
      });
      
      return card;
    }
    
    // Обновление данных задания
    function updateTaskData(index, element) {
      const field = element.dataset.field;
      const orderIndex = element.dataset.order;
      const value = element.textContent.trim();
      
      if (field === 'machines') {
        tasksData[index].machines = value;
      } else if (orderIndex !== undefined) {
        tasksData[index].orders[orderIndex][field] = value;
      }
    }
    
    // Добавить подзаказ
    function addSubOrder(taskIndex) {
      tasksData[taskIndex].orders.push({
        cargo: '',
        from: '',
        to: '',
        customer: '',
        note: ''
      });
      renderTasks();
      
      // Прокрутка к новому подзаказу
      setTimeout(() => {
        const card = document.querySelector(`.task-card[data-index="${taskIndex}"]`);
        const newOrder = card.querySelector('.sub-order:last-child');
        newOrder.scrollIntoView({ behavior: 'smooth', block: 'center' });
        newOrder.querySelector('[data-field="cargo"]').focus();
      }, 100);
    }
    
    // Удалить подзаказ
    function removeSubOrder(taskIndex, orderIndex) {
      if (tasksData[taskIndex].orders.length > 1) {
        tasksData[taskIndex].orders.splice(orderIndex, 1);
        renderTasks();
        showStatus('Заказ удален', 'success');
      }
    }
    
    // Переключение выделения
    function toggleSelection(index) {
      const card = document.querySelector(`.task-card[data-index="${index}"]`);
      if (selectedTasks.has(index)) {
        selectedTasks.delete(index);
        card.classList.remove('selected');
      } else {
        selectedTasks.add(index);
        card.classList.add('selected');
      }
    }
    
    // Добавление нового задания
    function addNewTask() {
      const newTask = {
        machines: '',
        orders: [{
          cargo: '',
          from: '',
          to: '',
          customer: '',
          note: ''
        }]
      };
      tasksData.push(newTask);
      
      const container = document.getElementById('tasksContainer');
      const newCard = createTaskCard(newTask, tasksData.length - 1);
      container.appendChild(newCard);
      
      // Фокус на первое поле
      newCard.querySelector('[data-field="machines"]').focus();
      
      // Прокрутка к новой карточке
      newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Дублировать выбранные задания
    function duplicateSelected() {
      if (selectedTasks.size === 0) {
        showStatus('Выберите задания для дублирования', 'error');
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        const original = tasksData[index];
        const duplicate = {
          machines: '', // Пустые машины для дубликата
          orders: original.orders.map(order => ({...order})) // Копируем заказы
        };
        tasksData.splice(index + 1, 0, duplicate);
      });
      
      renderTasks();
      showStatus(`Продублировано заданий: ${indices.length}`, 'success');
    }
    
    // Удалить выбранные задания
    function deleteSelected() {
      if (selectedTasks.size === 0) {
        showStatus('Выберите задания для удаления', 'error');
        return;
      }
      
      if (!confirm(`Удалить выбранные задания (${selectedTasks.size} шт.)?`)) {
        return;
      }
      
      const indices = Array.from(selectedTasks).sort((a, b) => b - a);
      indices.forEach(index => {
        tasksData.splice(index, 1);
      });
      
      renderTasks();
      showStatus('Задания удалены', 'success');
    }
    
    // Показать диалог управления
    function showManageDialog() {
      showModal('manageModal');
    }
    
    // Показать быстрое меню
    function showQuickMenu(element, type) {
      // Удаляем существующее меню
      const existingMenu = document.querySelector('.quick-menu');
      if (existingMenu) existingMenu.remove();
      
      const menu = document.createElement('div');
      menu.className = 'quick-menu';
      
      const options = templates[type] || [];
      const taskIndex = element.closest('.task-card').dataset.index;
      const orderIndex = element.dataset.order;
      const field = element.dataset.field;
      
      menu.innerHTML = `
        <button class="quick-menu-close" onclick="this.parentElement.remove()">×</button>
        <h3>Выберите ${type === 'cargo' ? 'груз' : 'заказчика'}</h3>
        ${options.map(option => 
          `<button class="quick-option" onclick="selectQuickOption('${field}', ${taskIndex}, '${option.replace(/'/g, "\\'")}', ${orderIndex})">${option}</button>`
        ).join('')}
      `;
      
      document.body.appendChild(menu);
      
      // Закрытие по клику вне меню
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target) && !element.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 100);
    }
    
    // Выбор из быстрого меню
    function selectQuickOption(field, taskIndex, value, orderIndex) {
      try {
        const card = document.querySelector(`.task-card[data-index="${taskIndex}"]`);
        if (!card) {
          console.error('Карточка не найдена');
          return;
        }
        
        const selector = orderIndex !== undefined ? 
          `[data-field="${field}"][data-order="${orderIndex}"]` : 
          `[data-field="${field}"]`;
        const fieldElement = card.querySelector(selector);
        
        if (!fieldElement) {
          console.error('Поле не найдено:', selector);
          return;
        }
        
        fieldElement.textContent = value;
        
        // Обновляем данные
        if (field === 'machines') {
          tasksData[taskIndex].machines = value;
        } else {
          const oIndex = orderIndex !== undefined ? parseInt(orderIndex) : 0;
          tasksData[taskIndex].orders[oIndex][field] = value;
        }
        
        // Убираем меню
        const menu = document.querySelector('.quick-menu');
        if (menu) menu.remove();
        
        showStatus('Выбрано: ' + value, 'success');
      } catch (error) {
        console.error('Ошибка при выборе:', error);
        showError('Ошибка при выборе значения');
      }
    }
    
    // Сохранение данных
    function saveData() {
      showStatus('Сохранение...');
      
      // Преобразуем в старый формат для сохранения
      const dataToSave = convertToOldFormat(tasksData.filter(t => t.machines));
      
      google.script.run
        .withSuccessHandler(() => {
          showStatus('Сохранено!', 'success');
        })
        .withFailureHandler(showError)
        .saveToSheet(currentSheet, dataToSave);
    }
    
    // Отправка в Telegram
    function sendToTelegram() {
      const message = formatForTelegram();
      
      showStatus('Отправка в Telegram...');
      google.script.run
        .withSuccessHandler(() => {
          showStatus('Отправлено в Telegram!', 'success');
        })
        .withFailureHandler(showError)
        .sendToTelegram(currentSheet, message);
    }
    
    // Копирование в буфер обмена
    function copyToClipboard() {
      const message = formatForTelegram();
      
      navigator.clipboard.writeText(message)
        .then(() => showStatus('Скопировано!', 'success'))
        .catch(() => {
          // Fallback для старых браузеров
          const textarea = document.createElement('textarea');
          textarea.value = message;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          showStatus('Скопировано!', 'success');
        });
    }
    
    // Форматирование для Telegram
    function formatForTelegram() {
      let message = `📅 ${currentSheet}\n\n`;
      
      tasksData.forEach((task, taskIndex) => {
        if (!task.machines) return;
        
        message += `🚛 ${task.machines}\n`;
        
        task.orders.forEach((order, orderIndex) => {
          if (task.orders.length > 1) {
            message += `  ${orderIndex + 1}. `;
          } else {
            message += `  `;
          }
          
          message += `📦 ${order.cargo || '-'} | `;
          message += `📍 ${order.from || '?'} → ${order.to || '?'} | `;
          message += `👤 ${order.customer || '-'}`;
          
          if (order.note) {
            message += `\n     📝 ${order.note}`;
          }
          message += '\n';
        });
        
        message += '\n';
      });
      
      return message.trim();
    }
    
    // Показать диалог создания
    function showModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
      const input = document.querySelector(`#${modalId} input`);
      if (input) {
        input.value = '';
        setTimeout(() => input.focus(), 100);
      }
    }
    
    // Закрыть модальное окно
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Создать новый лист
    function createNewSheet() {
      const name = document.getElementById('newSheetName').value.trim();
      if (!name) {
        showError('Введите название');
        return;
      }
      
      google.script.run
        .withSuccessHandler(() => {
          closeModal('createModal');
          loadSheets();
          showStatus('Лист создан', 'success');
        })
        .withFailureHandler(showError)
        .addNewSheet(name);
    }
    
    // Показать диалог переименования
    function showRenameDialog() {
      if (!currentSheet) return;
      
      const input = document.getElementById('renameInput');
      input.value = currentSheet;
      showModal('renameModal');
    }
    
    // Подтвердить переименование
    function confirmRename() {
      const newName = document.getElementById('renameInput').value.trim();
      if (!newName || newName === currentSheet) {
        closeModal('renameModal');
        return;
      }
      
      google.script.run
        .withSuccessHandler(() => {
          closeModal('renameModal');
          loadSheets();
          showStatus('Переименовано', 'success');
        })
        .withFailureHandler(showError)
        .renameSheet(currentSheet, newName);
    }
    
    // Показать диалог удаления
    function showDeleteDialog() {
      if (!currentSheet) return;
      
      document.getElementById('deleteText').textContent = `Удалить лист "${currentSheet}"?`;
      showModal('deleteModal');
    }
    
    // Подтвердить удаление
    function confirmDelete() {
      google.script.run
        .withSuccessHandler(() => {
          closeModal('deleteModal');
          loadSheets();
          showStatus('Лист удален', 'success');
        })
        .withFailureHandler(showError)
        .deleteSheet(currentSheet);
    }
    
    // Показать шаблоны
    function showTemplates() {
      const menu = document.createElement('div');
      menu.className = 'quick-menu';
      
      menu.innerHTML = `
        <button class="quick-menu-close" onclick="this.parentElement.remove()">×</button>
        <h3>📋 Быстрые шаблоны</h3>
        
        <h4 style="margin-top: 20px;">🚛 Популярные машины</h4>
        <div class="template-chips">
          ${templates.machines.map(m => 
            `<button class="chip" onclick="quickAddMachine('${m}')">${m}</button>`
          ).join('')}
        </div>
        
        <h4 style="margin-top: 20px;">📦 Типовые заказы</h4>
        <button class="quick-option" onclick="addTemplateTask('sand')">Песок (стандартный маршрут)</button>
        <button class="quick-option" onclick="addTemplateTask('gravel')">Щебень (стандартный маршрут)</button>
        <button class="quick-option" onclick="addTemplateTask('asphalt')">Асфальт (стандартный маршрут)</button>
        <button class="quick-option" onclick="addTemplateTask('hourly')">Почасовая работа</button>
      `;
      
      document.body.appendChild(menu);
    }
    
    // Добавить шаблонный заказ
    function addTemplateTask(type) {
      let newTask = {
        machines: '',
        orders: [{
          cargo: '',
          from: '',
          to: '',
          customer: '',
          note: ''
        }]
      };
      
      switch(type) {
        case 'sand':
          newTask.orders[0] = {
            cargo: 'песок',
            from: 'селычка',
            to: 'завьялово',
            customer: 'ООО Союзпромсирой',
            note: ''
          };
          break;
        case 'gravel':
          newTask.orders[0] = {
            cargo: 'щебень 31/63 м800',
            from: 'с поймы 34',
            to: 'Можга',
            customer: 'ООО Дорстрой 44',
            note: ''
          };
          break;
        case 'asphalt':
          newTask.orders[0] = {
            cargo: 'асфальт',
            from: 'абз агат',
            to: 'баграш бигра',
            customer: 'ООО ДМС',
            note: ''
          };
          break;
        case 'hourly':
          newTask.orders[0] = {
            cargo: 'почасовая',
            from: '',
            to: '',
            customer: '',
            note: 'указать время и место'
          };
          break;
      }
      
      tasksData.push(newTask);
      const container = document.getElementById('tasksContainer');
      const newCard = createTaskCard(newTask, tasksData.length - 1);
      container.appendChild(newCard);
      
      newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      document.querySelector('.quick-menu').remove();
      
      // Фокус на поле машины
      newCard.querySelector('[data-field="machines"]').focus();
      
      showStatus('Добавлен шаблонный заказ', 'success');
    }
    
    // Быстрое добавление машины
    function quickAddMachine(machine) {
      const newTask = {
        machines: machine,
        orders: [{
          cargo: '',
          from: '',
          to: '',
          customer: '',
          note: ''
        }]
      };
      
      tasksData.push(newTask);
      const container = document.getElementById('tasksContainer');
      const newCard = createTaskCard(newTask, tasksData.length - 1);
      container.appendChild(newCard);
      
      newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
      document.querySelector('.quick-menu').remove();
      
      // Фокус на первый заказ
      newCard.querySelector('[data-field="cargo"]').focus();
      
      showStatus(`Добавлена машина ${machine}`, 'success');
    }
    
    // Показать статус
    function showStatus(message, type = '') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
      
      if (type) {
        setTimeout(() => {
          status.style.display = 'none';
        }, 3000);
      }
    }
    
    // Скрыть статус
    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }
    
    // Показать ошибку
    function showError(error) {
      console.error(error);
      showStatus(error.message || error, 'error');
    }
  </script>
</body>
</html>